<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realm Architect: Multiplayer Edition</title>
    <!-- Tailwind CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght=300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark Slate Gray */
            color: #d1d5db; /* Light Gray */
        }
        .cinzel {
            font-family: 'Cinzel', serif;
        }
        .card {
            background-color: #374151; /* Medium Slate Gray */
            border: 1px solid #4b5563; /* Border */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #f59e0b; /* Amber */
            color: #1f2937;
            font-weight: bold;
            transition: all 0.15s;
        }
        .btn-primary:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .coin-face {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #coin, #duoCoin {
            width: 80px;
            height: 80px;
            margin: 20px auto;
            transform-style: preserve-3d;
            perspective: 1000px;
            transition: transform 1.5s cubic-bezier(0.4, 2.5, 0.55, 0.5);
        }
        #coin .front { background-color: #10b981; transform: rotateY(0deg); }
        #coin .back { background-color: #ef4444; transform: rotateY(180deg); }
        #duoCoin .front { background-color: #3b82f6; transform: rotateY(0deg); } /* Blue */
        #duoCoin .back { background-color: #ef4444; transform: rotateY(180deg); } /* Red */
        
        input[type="text"], select, textarea {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #f3f4f6;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 1px #f59e0b;
        }
    </style>
    
    <!-- ⚠️ YOUR FIREBASE CONFIGURATION ⚠️ -->
    <script>
        // CONFIGURATION
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyCoRExE1mKJqKb6b5Kv1Suxun4DuMkMnG0",
            authDomain: "real-96b07.firebaseapp.com",
            projectId: "real-96b07",
            storageBucket: "real-96b07.firebasestorage.app",
            messagingSenderId: "699368878306",
            appId: "1:699368878306:web:936026a24ec82a0d59eebb",
            measurementId: "G-H86F01XPM3"
        });
        window.__app_id = "real-96b07"; 
        
        // FLAG TO TRACK SUCCESS
        window.firebaseInitSuccess = false;
    </script>
    
    <!-- Firebase Imports and Main Application Logic -->
    <script type="module">
        // 1. Static Imports: Using CDN links for browser compatibility
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- UTILITY FUNCTIONS ---
        function showNotification(message, className) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-[99] p-4 rounded-lg shadow-xl text-white font-bold transition-all duration-300 ${className}`;
            notification.innerHTML = `<i class="fa-solid fa-bell mr-2"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.classList.remove('top-4');
                notification.classList.add('top-0');
                setTimeout(() => notification.remove(), 500);
            }, 5000); 
        }

        window.renderPlayers = () => {
            const list = document.getElementById('playerList');
            const currentPlayers = window.players || [];
            
            if (currentPlayers.length === 0) {
                list.innerHTML = '<li class="text-slate-500 text-center text-sm p-4">Waiting for players to join...</li>';
                return;
            }

            const sortedPlayers = [...currentPlayers].sort((a, b) => b.techLevel - a.techLevel);
            
            list.innerHTML = sortedPlayers.map(p => `
                <li class="p-3 bg-slate-700/50 rounded-lg flex justify-between items-center border border-slate-600 shadow-md">
                    <div class="flex items-center space-x-3">
                        <i class="fa-solid fa-user-circle text-lg ${p.id === localPlayerId ? 'text-green-400' : 'text-slate-400'}"></i>
                        <span class="font-bold ${p.id === localPlayerId ? 'text-white' : 'text-slate-200'}">${p.name} ${p.id === localPlayerId ? '(You)' : ''}</span>
                    </div>
                    <div class="text-right text-sm">
                        <span class="text-yellow-400 font-mono">⚡${p.energy}</span>
                        <span class="text-indigo-400 ml-3">Tech: ${p.techLevel}</span>
                        ${p.inventory && p.inventory.length > 0 ? `<span class="ml-3 text-red-300">⚔️ ${p.inventory.length} items</span>` : ''}
                    </div>
                </li>
            `).join('');
            
            const currentPlayer = currentPlayers.find(p => p.id === localPlayerId);
            if(currentPlayer) {
                document.getElementById('myEnergyDisplay').innerText = currentPlayer.energy;
                document.getElementById('myTechLevelDisplay').innerText = currentPlayer.techLevel;
            }

            // Also update the World Data Preview if available
            const worldPreview = document.getElementById('worldDataPreview');
            if (currentPlayer && currentPlayer.worldData && currentPlayer.worldData.countryName) {
                const data = currentPlayer.worldData;
                worldPreview.innerHTML = `
                    <p class="text-sm font-bold text-slate-100 mb-1">${data.countryName || 'Untitled Country'}</p>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                        <p class="text-slate-400"><i class="fa-solid fa-mountain-sun mr-1"></i> Terrain: ${data.terrain}</p>
                        <p class="text-slate-400"><i class="fa-solid fa-cloud-sun-rain mr-1"></i> Climate: ${data.climate}</p>
                        <p class="text-slate-400"><i class="fa-solid fa-gem mr-1"></i> Resources: ${data.resources}</p>
                        <p class="text-slate-400"><i class="fa-solid fa-arrow-right-arrow-left mr-1"></i> Export: ${data.export}</p>
                    </div>
                    <p class="text-xs text-slate-500 italic mt-2">${data.unique ? data.unique.substring(0, 50) + '...' : 'No unique trait defined.'}</p>
                `;
            } else {
                worldPreview.innerHTML = '<p class="text-xs text-slate-500 italic">No world data saved yet. Fill out the form below to create your country!</p>';
            }
        };
        
        // --- NEW FUNCTION TO LOAD LIVE DATA INTO THE FORM ---
        window.loadWorldData = () => {
            const currentPlayer = window.players.find(p => p.id === localPlayerId);
            const formElements = document.getElementById('worldForm').elements;
            
            if (!currentPlayer || !currentPlayer.worldData) {
                // Clear or initialize form if no data exists (implicitly creates a "new" country)
                document.getElementById('worldForm').reset();
                formElements.resources.value = 'None'; 
                // Set initial values if you want defaults instead of empty
            } else {
                const data = currentPlayer.worldData;
                
                // Populate form fields from the current player's worldData
                // This connects the form to the "live stats" (the player object in the array)
                formElements.terrain.value = data.terrain || 'Plains';
                formElements.resources.value = data.resources || 'None';
                formElements.climate.value = data.climate || 'Temperate';
                formElements.countryName.value = data.countryName || '';
                formElements.capitalCity.value = data.capitalCity || '';
                formElements.language.value = data.language || '';
                formElements.export.value = data.export || '';
                formElements.culture.value = data.culture || '';
                formElements.history.value = data.history || '';
                formElements.unique.value = data.unique || '';
            }

            // Ensure the crafting resource dropdown reflects the player's resource choice
            window.checkCraftingOptions();
        };

        window.updateSelects = () => {
            const currentPlayers = window.players || [];
            const playerOptions = currentPlayers.map(p => `<option value="${p.id}">${p.name} (T${p.techLevel})</option>`).join('');
            
            const updateSelect = (id, defaultText) => {
                const el = document.getElementById(id);
                const currentVal = el.value;
                el.innerHTML = `<option value="">${defaultText}</option>` + playerOptions;
                if (currentVal && currentPlayers.find(p => p.id === currentVal)) {
                    el.value = currentVal;
                }
            };

            updateSelect('p1Select', 'P1 - Select Player');
            updateSelect('p2Select', 'P2 - Select Player');
            updateSelect('researcherSelect', 'Select Researcher');
            updateSelect('crafterSelect', 'Select Crafter');
            updateSelect('t1p1Select', 'Team 1 (P1)');
            updateSelect('t1p2Select', 'Team 1 (P2)');
            updateSelect('t2p1Select', 'Team 2 (P1)');
            updateSelect('t2p2Select', 'Team 2 (P2)');

            window.updateBattleOdds();
            window.updateDuoBattleOdds();
            window.checkCraftingOptions();
        };

        window.findPlayerById = (id) => (window.players || []).find(p => p.id === id);

        // Logic for World Data Save (Realm Save Data button fix)
        window.saveWorldToPlayer = async () => {
            if (!localPlayerId) return showNotification("You are not logged in!", 'bg-red-600');
            
            const currentPlayer = window.players.find(p => p.id === localPlayerId);
            if (!currentPlayer) return showNotification("Player object not found in realm data!", 'bg-red-600');

            const formElements = document.getElementById('worldForm').elements;
            const worldData = {
                terrain: formElements.terrain.value,
                resources: formElements.resources.value,
                climate: formElements.climate.value,
                countryName: formElements.countryName.value,
                capitalCity: formElements.capitalCity.value,
                language: formElements.language.value,
                export: formElements.export.value,
                culture: formElements.culture.value,
                history: formElements.history.value,
                unique: formElements.unique.value,
            };

            // 1. Update ONLY the current player's entry in the global array
            const updatedPlayers = window.players.map(p => {
                if (p.id === localPlayerId) {
                    // This is the core logic that prevents changing other players' data
                    return { 
                        ...p, 
                        worldData: worldData, // Saved from the form
                        lastUpdate: Date.now()
                    };
                }
                // Return all other players' data unchanged
                return p;
            });

            // 2. Save the whole updated array back to Firestore
            const success = await window.saveToDb(updatedPlayers);
            if (success) {
                showNotification("World Data Saved Successfully!", 'bg-green-600');
            }
        };

        window.conductResearch = async () => {
            const playerId = document.getElementById('researcherSelect').value;
            if (!playerId) return showNotification("Select a researcher!", 'bg-red-600');
            const player = window.findPlayerById(playerId);
            if (!player) return showNotification("Player not found!", 'bg-red-600');
            // Client-side security check: only the local player can initiate this action for themselves
            if (player.id !== localPlayerId) return showNotification("You can only research for yourself!", 'bg-red-600');
            if (player.energy < 2) return showNotification(`${player.name} needs 2 Energy to research!`, 'bg-red-600');

            const index = window.players.findIndex(p => p.id === playerId);
            const updatedPlayers = [...window.players];
            updatedPlayers[index].energy -= 2;
            updatedPlayers[index].techLevel += 1;
            updatedPlayers[index].lastUpdate = Date.now();

            const success = await window.saveToDb(updatedPlayers);
            if (success) {
                showNotification(`${player.name} researched new tech! Tech Level is now ${updatedPlayers[index].techLevel}.`, 'bg-indigo-600');
            }
        };

        window.craftItem = async () => {
            const playerId = document.getElementById('crafterSelect').value;
            const schematic = document.getElementById('schematicInput').value.trim();
            const requiredResource = document.getElementById('resources').value;
            if (!playerId) return showNotification("Select a crafter!", 'bg-red-600');
            if (!schematic) return showNotification("Enter a schematic name!", 'bg-red-600');
            if (requiredResource === 'None') return showNotification("Set a primary world resource first!", 'bg-red-600');
            const player = window.findPlayerById(playerId);
            if (!player) return showNotification("Player not found!", 'bg-red-600');
            // Client-side security check: only the local player can initiate this action for themselves
            if (player.id !== localPlayerId) return showNotification("You can only craft for yourself!", 'bg-red-600');
            if (player.energy < 5) return showNotification(`${player.name} needs 5 Energy to craft!`, 'bg-red-600');
            if (player.techLevel < 3) return showNotification(`${player.name} needs Tech Level 3 to craft complex items!`, 'bg-red-600');

            const index = window.players.findIndex(p => p.id === playerId);
            const updatedPlayers = [...window.players];
            updatedPlayers[index].energy -= 5;
            updatedPlayers[index].inventory.push(`${schematic} (${requiredResource})`);
            updatedPlayers[index].lastUpdate = Date.now();

            const success = await window.saveToDb(updatedPlayers);
            if (success) {
                showNotification(`${player.name} crafted ${schematic} using ${requiredResource}!`, 'bg-green-600');
            }
        };

        window.checkCraftingOptions = () => {
            const resource = document.getElementById('worldForm')?.elements?.resources?.value || 'None';
            document.getElementById('craftingStatus').innerText = `Resource: ${resource}`;
        };

        window.updateBattleOdds = () => {
            const p1Id = document.getElementById('p1Select').value;
            const p2Id = document.getElementById('p2Select').value;
            const p1 = window.findPlayerById(p1Id);
            const p2 = window.findPlayerById(p2Id);
            
            let p1Level = p1 ? p1.techLevel : 0;
            let p2Level = p2 ? p2.techLevel : 0;

            if (p1Id === p2Id && p1Id !== "") {
                document.getElementById('oddsDisplay').innerText = "ERROR: Cannot battle yourself!";
                return;
            }

            let diff = p1Level - p2Level;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 5);
            let p1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);
            let p2Odd = 100 - p1Odd;
            document.getElementById('oddsDisplay').innerText = `Odds: P1 (${p1Odd}%) vs P2 (${p2Odd}%)`;
        };

        window.battleFlip = async () => {
            const p1Id = document.getElementById('p1Select').value;
            const p2Id = document.getElementById('p2Select').value;
            const p1 = window.findPlayerById(p1Id);
            const p2 = window.findPlayerById(p2Id);
            if (!p1 || !p2 || p1Id === p2Id) {
                return showNotification("Select two unique players for the battle!", 'bg-red-600');
            }
            // Add a check to ensure one of the players is the local player to prevent unauthorized action
            if (p1Id !== localPlayerId && p2Id !== localPlayerId) {
                return showNotification("You must be one of the combatants to initiate a battle!", 'bg-red-600');
            }


            let diff = p1.techLevel - p2.techLevel;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 5);
            let p1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);

            const coin = document.getElementById('coin');
            coin.style.transition = 'none';
            coin.style.transform = 'rotateY(0deg)';
            await new Promise(resolve => setTimeout(resolve, 50));

            const random = Math.random() * 100;
            const winnerId = (random < p1Odd) ? p1Id : p2Id;
            const flipResult = (winnerId === p1Id) ? 'heads' : 'tails';

            const newBattleState = {
                ...battleState,
                lastBattleId: battleState.lastBattleId + 1,
                result: flipResult,
                winner: winnerId
            };
            if (winnerId === p1Id) {
                newBattleState.p1 += 1;
            } else {
                newBattleState.p2 += 1;
            }
            const success = await window.saveToDb(window.players, newBattleState);
            if (success) {
                // Animation will be triggered by onSnapshot
            }
        };

        window.updateDuoBattleOdds = () => {
            const t1p1 = window.findPlayerById(document.getElementById('t1p1Select').value);
            const t1p2 = window.findPlayerById(document.getElementById('t1p2Select').value);
            const t2p1 = window.findPlayerById(document.getElementById('t2p1Select').value);
            const t2p2 = window.findPlayerById(document.getElementById('t2p2Select').value);
            let t1Level = (t1p1 ? t1p1.techLevel : 0) + (t1p2 ? t1p2.techLevel : 0);
            let t2Level = (t2p1 ? t2p1.techLevel : 0) + (t2p2 ? t2p2.techLevel : 0);
            const allPlayers = [t1p1, t1p2, t2p1, t2p2].filter(p => p);
            const playerIds = allPlayers.map(p => p.id);
            if (new Set(playerIds).size !== playerIds.length) {
                document.getElementById('duoOddsDisplay').innerText = "ERROR: Duplicate players detected!";
                return;
            }
            let diff = t1Level - t2Level;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 3);
            let t1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);
            let t2Odd = 100 - t1Odd;
            document.getElementById('duoOddsDisplay').innerText = `Odds: Team 1 (${t1Odd}%) vs Team 2 (${t2Odd}%)`;
        };

        window.duoBattleFlip = async () => {
            const t1p1 = window.findPlayerById(document.getElementById('t1p1Select').value);
            const t1p2 = window.findPlayerById(document.getElementById('t1p2Select').value);
            const t2p1 = window.findPlayerById(document.getElementById('t2p1Select').value);
            const t2p2 = window.findPlayerById(document.getElementById('t2p2Select').value);

            const t1Ids = [t1p1?.id, t1p2?.id].filter(Boolean);
            const t2Ids = [t2p1?.id, t2p2?.id].filter(Boolean);
            const allIds = [...t1Ids, ...t2Ids];
            const localPlayerInvolved = allIds.includes(localPlayerId);

            if (!t1p1 || !t2p1) { 
                return showNotification("Select at least P1 for Team 1 and P1 for Team 2!", 'bg-red-600');
            }
            if (!localPlayerInvolved) {
                return showNotification("You must be part of one of the teams to initiate a battle!", 'bg-red-600');
            }

            let t1Level = (t1p1 ? t1p1.techLevel : 0) + (t1p2 ? t1p2.techLevel : 0);
            let t2Level = (t2p1 ? t2p1.techLevel : 0) + (t2p2 ? t2p2.techLevel : 0);
            let diff = t1Level - t2Level;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 3);
            let t1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);
            const coin = document.getElementById('duoCoin');
            coin.style.transition = 'none';
            coin.style.transform = 'rotateY(0deg)';
            await new Promise(resolve => setTimeout(resolve, 50));
            const random = Math.random() * 100;
            const winnerTeam = (random < t1Odd) ? 't1' : 't2';
            const flipResult = (winnerTeam === 't1') ? 'heads' : 'tails';
            const newDuoBattleState = {
                ...duoBattleState,
                lastBattleId: duoBattleState.lastBattleId + 1,
                result: flipResult,
                winner: winnerTeam
            };
            if (winnerTeam === 't1') {
                newDuoBattleState.t1 += 1;
            } else {
                newDuoBattleState.t2 += 1;
            }
            const success = await window.saveToDb(window.players, battleState, newDuoBattleState);
            if (success) {
                // Animation will be triggered by onSnapshot
            }
        };

        window.resetBattle = async () => {
            const newBattleState = { p1: 0, p2: 0, lastBattleId: battleState.lastBattleId, result: null, winner: null };
            const success = await window.saveToDb(window.players, newBattleState, duoBattleState);
            if (success) {
                showNotification("1v1 Score Reset!", 'bg-slate-600');
            }
        };

        window.resetDuoBattle = async () => {
            const newDuoBattleState = { t1: 0, t2: 0, lastBattleId: duoBattleState.lastBattleId, result: null, winner: null };
            const success = await window.saveToDb(window.players, battleState, newDuoBattleState);
              if (success) {
                showNotification("2v2 Score Reset!", 'bg-slate-600');
            }
        };

        window.triggerBattleAnimation = (newState, coinId, resultDisplayId, isDuo = false) => {
            const coin = document.getElementById(coinId);
            const resultDisplay = document.getElementById(resultDisplayId);
            
            // Determine names for display
            let team1Name = isDuo ? 'Team 1 (Blue)' : 'P1';
            let team2Name = isDuo ? 'Team 2 (Red)' : 'P2';
            if (!isDuo) {
                 const p1 = window.findPlayerById(document.getElementById('p1Select').value);
                 const p2 = window.findPlayerById(document.getElementById('p2Select').value);
                 if (p1) team1Name = p1.name;
                 if (p2) team2Name = p2.name;
            }
            
            coin.style.transition = 'none';
            coin.style.transform = 'rotateY(0deg)';
            void coin.offsetWidth; 
            coin.style.transition = 'transform 1.5s cubic-bezier(0.4, 2.5, 0.55, 0.5)';
            if (newState.result === 'heads') {
                coin.style.transform = 'rotateY(3600deg)';
            } else {
                coin.style.transform = 'rotateY(3780deg)'; // 3600 + 180
            }
            resultDisplay.innerText = 'Flipping...';

            setTimeout(() => {
                let winnerText = isDuo 
                    ? (newState.winner === 't1' ? team1Name : team2Name)
                    : (newState.winner === document.getElementById('p1Select').value ? team1Name : team2Name);
                
                // If the player selects change after the flip, this fallback ensures a name is shown.
                if (!winnerText || winnerText === 'P1' || winnerText === 'P2' || winnerText === 'Team 1 (Blue)' || winnerText === 'Team 2 (Red)') {
                     winnerText = (newState.winner === document.getElementById('p1Select').value) ? team1Name : team2Name;
                }
                
                resultDisplay.innerHTML = `<span class="text-xl font-extrabold">${winnerText} WINS!</span>`;
                setTimeout(() => {
                    resultDisplay.innerText = '';
                }, 4000);
            }, 1800);
        };

        window.switchBattleMode = (mode) => {
            document.getElementById('battleGUI_1v1').classList.toggle('hidden', mode !== '1v1');
            document.getElementById('battleGUI_2v2').classList.toggle('hidden', mode !== '2v2');
            document.getElementById('btn1v1').classList.toggle('bg-yellow-600', mode === '1v1');
            document.getElementById('btn1v1').classList.toggle('bg-slate-700', mode !== '1v1');
            document.getElementById('btn1v1').classList.toggle('text-white', mode === '1v1');
            document.getElementById('btn1v1').classList.toggle('text-slate-300', mode !== '1v1');
            document.getElementById('btn2v2').classList.toggle('bg-yellow-600', mode === '2v2');
            document.getElementById('btn2v2').classList.toggle('bg-slate-700', mode !== '2v2');
            document.getElementById('btn2v2').classList.toggle('text-white', mode === '2v2');
            document.getElementById('btn2v2').classList.toggle('text-slate-300', mode !== '2v2');
        }

        // --- FIREBASE INITIALIZATION & AUTH ---
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        let app, auth, db, appId;
        let currentUser = null;
        let localPlayerId = null; 
        let localPlayerName = ''; 
        let currentRealmId = null;
        let unsubscribe = null;
        let analytics = null;
        let isFirebaseAvailable = true;

        window.players = [];
        let battleState = { p1: 0, p2: 0, lastBattleId: 0, result: null, winner: null };
        let duoBattleState = { t1: 0, t2: 0, lastBattleId: 0, result: null, winner: null };
        
        // FUNCTION TO FORCE LOCAL MODE IF AUTH FAILS
        window.forceLocalMode = (reason) => {
            if (window.firebaseInitSuccess) return; // Already succeeded
            
            console.warn("Forcing Local Mode:", reason);
            isFirebaseAvailable = false;
            localPlayerId = crypto.randomUUID();
            
            // UI Updates
            const loader = document.getElementById('loadingAuth');
            if(loader) loader.classList.add('hidden');
            
            const warningBox = document.getElementById('localModeWarning');
            if(warningBox) warningBox.classList.remove('hidden');
            
            const userIdDisplay = document.getElementById('currentUserId');
            if(userIdDisplay) userIdDisplay.innerText = localPlayerId.substring(0, 8) + '... (Offline)';
            
            const lobby = document.getElementById('lobbyScreen');
            if(lobby) lobby.classList.remove('hidden');
            
            const statusMsg = document.getElementById('loadingStatusMsg');
            if(statusMsg) statusMsg.innerText = "Connection Failed. Running Offline.";
        }

        async function initAuth() {
            document.getElementById('loadingAuth').classList.remove('hidden');
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                analytics = getAnalytics(app);
                appId = window.__app_id || firebaseConfig.projectId;
                setLogLevel('error');
                console.log("Firebase App Initialized.");

                let authSuccess = false;

                // Try Custom Token first (if available)
                if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token.length > 0) {
                    try {
                        console.log("Attempting Custom Token Auth...");
                        await signInWithCustomToken(auth, window.__initial_auth_token);
                        authSuccess = true;
                    } catch (e) {
                         // Fallback to Anonymous if custom token fails (mismatch config)
                        console.warn("Custom token auth failed. Falling back to Anonymous Auth.", e);
                    }
                }

                // Fallback to Anonymous Auth if custom token failed or wasn't present
                if (!authSuccess) {
                     console.log("Attempting Anonymous Auth...");
                     await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.firebaseInitSuccess = true; // Flag success
                        currentUser = user;
                        localPlayerId = user.uid;
                        document.getElementById('currentUserId').innerText = localPlayerId;
                        document.getElementById('lobbyScreen').classList.remove('hidden');
                        document.getElementById('loadingAuth').classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Critical Auth Error:", error);
                
                // SPECIFIC ERROR MESSAGES FOR USER
                if (error.code === 'auth/operation-not-allowed' || error.code === 'auth/admin-restricted-operation') {
                     // FIX 1: Provide clearer guidance for Anonymous Sign-in not enabled
                     showNotification("ERROR: Anonymous Sign-in Disabled. Enable it in Firebase Console -> Authentication -> Sign-in method.", "bg-red-900 border-2 border-red-500 w-96");
                } else if (error.code === 'auth/configuration-not-found') {
                     // FIX 2: Provide clearer guidance for Authentication service not initialized
                     showNotification("ERROR: Firebase Auth Not Found. 1. Go to Firebase Console. 2. Click 'Authentication' and 'Get Started' to initialize the service.", "bg-red-900 border-2 border-red-500 w-96");
                }
                
                window.forceLocalMode(error.message);
            }
        }

        window.joinRealm = async () => {
            const code = document.getElementById('realmCodeInput').value.trim().toUpperCase();
            const name = document.getElementById('playerNameInput').value.trim();
            if (!code) return showNotification("Enter a Realm Code!", 'bg-red-600');
            if (!name) return showNotification("Enter your Player Name!", 'bg-red-600');
            
            localPlayerName = name;
            currentRealmId = code;
            
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('realmDisplay').innerText = `Realm: ${code} | Player: ${localPlayerName}`;
            document.getElementById('currentArchitectName').innerText = localPlayerName; 
            
            setupRealtimeListener();
        };

        function setupRealtimeListener() {
            if (!auth.currentUser || !isFirebaseAvailable) {
                 document.getElementById('realmDisplay').innerText = `Realm: ${currentRealmId} (Local Only)`;
                 if (window.players.length === 0) {
                     window.players.push({
                         id: localPlayerId,
                         name: localPlayerName,
                         energy: 10,
                         techLevel: 0,
                         inventory: [],
                         lastUpdate: Date.now(),
                         worldData: null
                     });
                 }
                 window.renderPlayers();
                 window.updateSelects();
                 window.loadWorldData(); // <-- Load data even in local mode
                 return;
            }

            const realmRef = doc(db, 'artifacts', appId, 'public', 'data', `realm_${currentRealmId}`);

            unsubscribe = onSnapshot(realmRef, (docSnap) => {
                let data = docSnap.exists() ? docSnap.data() : {};
                let localPlayers = data.players || [];
                let currentPlayer = localPlayers.find(p => p.id === localPlayerId);
                let needsUpdate = false;
                
                if (!currentPlayer) {
                    currentPlayer = {
                        id: localPlayerId,
                        name: localPlayerName,
                        energy: 10,
                        techLevel: 0,
                        inventory: [],
                        lastUpdate: Date.now(),
                        worldData: null
                    };
                    localPlayers.push(currentPlayer);
                    needsUpdate = true;
                } else if (currentPlayer.name !== localPlayerName) {
                    // Update name in Firestore if it changed locally
                    localPlayers = localPlayers.map(p => {
                        if (p.id === localPlayerId) {
                             if (p.name !== localPlayerName) {
                                 needsUpdate = true;
                                 return { ...p, name: localPlayerName };
                             }
                        }
                        return p;
                    });
                }

                if (needsUpdate) {
                    // Only use initialCreate=true when adding a player or updating name to avoid race conditions
                    window.saveToDb(localPlayers, data.battleState, data.duoBattleState, true);
                    return; 
                }
                
                window.players = localPlayers;
                
                if (data.battleState) {
                    if (data.battleState.lastBattleId !== battleState.lastBattleId) {
                        triggerBattleAnimation(data.battleState, 'coin', 'battleResult');
                    }
                    battleState = data.battleState;
                    document.getElementById('p1Score').innerText = battleState.p1;
                    document.getElementById('p2Score').innerText = battleState.p2;
                }
                if (data.duoBattleState) {
                    if (data.duoBattleState.lastBattleId !== duoBattleState.lastBattleId) {
                        triggerBattleAnimation(data.duoBattleState, 'duoCoin', 'duoBattleResult', true);
                    }
                    duoBattleState = data.duoBattleState;
                    document.getElementById('t1Score').innerText = duoBattleState.t1;
                    document.getElementById('t2Score').innerText = duoBattleState.t2;
                }
                
                // --- NEW: Run the data render/load sequence ---
                window.renderPlayers();
                window.updateSelects();
                window.loadWorldData(); // <-- Load the local player's world data into the form
                // ---------------------------------------------

                if (!docSnap.exists()) {
                    setDoc(realmRef, {
                        players: localPlayers,
                        battleState: battleState,
                        duoBattleState: duoBattleState,
                        createdAt: Date.now()
                    }).catch(e => console.error("Error setting initial document:", e));
                }
            }, (error) => {
                console.error("Sync Error:", error);
                document.getElementById('realmDisplay').innerText = `Realm: ${currentRealmId} (Sync Failed!)`;
                showNotification("Sync Failed: Check Permissions", 'bg-red-800');
            });
        }
        
        // saveToDb now returns boolean: true for success (local or remote), false for remote failure
        window.saveToDb = async (newPlayers, newBattleState = null, newDuoBattleState = null, initialCreate = false, attempt = 0) => {
            if (!auth?.currentUser || !isFirebaseAvailable) {
                // Local Mode Fallback
                window.players = newPlayers;
                if (newBattleState) battleState = newBattleState;
                if (newDuoBattleState) duoBattleState = newDuoBattleState;
                window.renderPlayers();
                window.updateSelects();
                window.loadWorldData(); // Ensure the form updates even offline
                
                if (!isFirebaseAvailable) {
                    if (!initialCreate && (newPlayers || newBattleState || newDuoBattleState)) {
                       showNotification("Data updated locally (Offline Mode). Data will not sync.", 'bg-orange-600');
                    }
                }
                return true;
            }
            
            const MAX_RETRIES = 3;
            const delay = 1000 * Math.pow(2, attempt);
            
            try {
                const realmRef = doc(db, 'artifacts', appId, 'public', 'data', `realm_${currentRealmId}`);
                
                // Prepare update object, merging existing state that wasn't explicitly passed
                const updateObject = { 
                    players: newPlayers,
                    battleState: newBattleState !== null ? newBattleState : battleState,
                    duoBattleState: newDuoBattleState !== null ? newDuoBattleState : duoBattleState,
                    lastModified: Date.now()
                };

                await setDoc(realmRef, updateObject, { merge: true });
                return true;

            } catch (error) {
                console.error(`Save attempt ${attempt + 1} failed for realm_${currentRealmId}:`, error);
                if (attempt < MAX_RETRIES - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return window.saveToDb(newPlayers, newBattleState, newDuoBattleState, initialCreate, attempt + 1);
                } else {
                    showNotification(`Failed to save data after ${MAX_RETRIES} attempts. Check permissions!`, 'bg-red-800 border-2 border-red-400');
                    return false;
                }
            }
        };

        window.onload = () => {
             // Set default battle mode on load
             window.switchBattleMode('1v1');
             initAuth();
        };

    </script>
</head>
<body class="p-4 md:p-8 min-h-screen">
    <div id="loadingAuth" class="fixed inset-0 bg-slate-800/90 z-50 flex flex-col items-center justify-center hidden">
        <i class="fa-solid fa-sync fa-spin text-yellow-500 text-6xl"></i>
        <p id="loadingStatusMsg" class="mt-4 text-xl text-slate-300">Connecting to Realm...</p>
        <p class="text-sm text-slate-500 mt-2">Checking Authentication Status...</p>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="hidden max-w-lg mx-auto p-6 card rounded-xl mt-16 md:mt-24 shadow-2xl">
        <h1 class="cinzel text-3xl font-bold text-center text-yellow-400 mb-6">Realm Architect</h1>
        <p class="text-slate-400 text-center mb-6">Enter a Realm Code and your Player Name to join the multiplayer session.</p>
        <div id="localModeWarning" class="bg-orange-700 p-3 rounded-lg text-sm mb-4 hidden">
            <i class="fa-solid fa-triangle-exclamation mr-2"></i> Running in Offline Mode. No real-time synchronization.
        </div>
        <div class="space-y-4">
            <div>
                <label for="realmCodeInput" class="block text-sm font-medium text-slate-300 mb-1">Realm Code (e.g., ALPHA)</label>
                <input type="text" id="realmCodeInput" value="CANVAS" class="w-full p-3 rounded-lg" placeholder="e.g. CANVAS">
            </div>
            <div>
                <label for="playerNameInput" class="block text-sm font-medium text-slate-300 mb-1">Your Player Name</label>
                <input type="text" id="playerNameInput" class="w-full p-3 rounded-lg" placeholder="Your Name or Country Leader">
            </div>
            <button onclick="window.joinRealm()" class="btn-primary w-full p-3 rounded-lg shadow-md hover:shadow-xl">
                <i class="fa-solid fa-dungeon mr-2"></i> Enter Realm
            </button>
        </div>
        <p class="text-xs text-slate-500 mt-6 text-center">Your User ID: <span id="currentUserId" class="font-mono text-slate-400">Loading...</span></p>
    </div>

    <!-- Main App Screen -->
    <div id="appScreen" class="hidden">
        <!-- Header -->
        <header class="mb-6 pb-4 border-b border-slate-700 flex justify-between items-center flex-wrap">
            <h1 class="cinzel text-2xl font-bold text-yellow-400" id="realmDisplay">Realm: ... | Player: ...</h1>
            <div class="text-sm font-semibold flex items-center space-x-4 mt-2 md:mt-0">
                <div class="p-2 card rounded-full shadow-lg">
                    <span class="text-yellow-300"><i class="fa-solid fa-bolt mr-1"></i> Energy: <span id="myEnergyDisplay">10</span></span>
                </div>
                <div class="p-2 card rounded-full shadow-lg">
                    <span class="text-indigo-300"><i class="fa-solid fa-microchip mr-1"></i> Tech Level: <span id="myTechLevelDisplay">0</span></span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Column 1: World Creation & Stats -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Player List -->
                <div class="card p-4 rounded-xl">
                    <h2 class="text-xl font-semibold mb-3 text-white"><i class="fa-solid fa-users mr-2 text-green-400"></i> Realm Architects (Ranked)</h2>
                    <ul id="playerList" class="space-y-2 text-sm">
                        <!-- Player list populated by JS -->
                    </ul>
                </div>

                <!-- Your World Data Preview -->
                <div class="card p-4 rounded-xl">
                    <h2 class="text-xl font-semibold mb-3 text-white"><i class="fa-solid fa-globe mr-2 text-sky-400"></i> Your Country: <span id="currentArchitectName" class="text-yellow-300"></span></h2>
                    <div id="worldDataPreview" class="p-3 bg-slate-800/70 rounded-lg min-h-[100px] flex flex-col justify-center">
                        <p class="text-xs text-slate-500 italic">No world data saved yet. Fill out the form below to create your country!</p>
                    </div>
                </div>

                <!-- World Creation Form (Live Stats) -->
                <div class="card p-4 rounded-xl">
                    <h2 class="text-xl font-semibold mb-3 text-white">Design Your Realm</h2>
                    <form id="worldForm" class="space-y-3">
                        <!-- Row 1 -->
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-slate-400">Terrain</label>
                                <select id="terrain" name="terrain" onchange="window.checkCraftingOptions()" class="w-full p-2 rounded-lg text-sm">
                                    <option>Plains</option>
                                    <option>Mountainous</option>
                                    <option>Desert</option>
                                    <option>Coastal</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400">Climate</label>
                                <select id="climate" name="climate" class="w-full p-2 rounded-lg text-sm">
                                    <option>Temperate</option>
                                    <option>Arid</option>
                                    <option>Tropical</option>
                                    <option>Frigid</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400">Primary Resource</label>
                                <select id="resources" name="resources" onchange="window.checkCraftingOptions()" class="w-full p-2 rounded-lg text-sm">
                                    <option value="None">None</option>
                                    <option>Iron Ore</option>
                                    <option>Lumber</option>
                                    <option>Exotic Spice</option>
                                    <option>Rare Crystals</option>
                                </select>
                            </div>
                        </div>

                        <!-- Row 2 -->
                        <div>
                            <label for="countryName" class="block text-xs font-medium text-slate-400">Country Name</label>
                            <input type="text" id="countryName" name="countryName" class="w-full p-2 rounded-lg text-sm" placeholder="The Sovereign State of...">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="capitalCity" class="block text-xs font-medium text-slate-400">Capital City</label>
                                <input type="text" id="capitalCity" name="capitalCity" class="w-full p-2 rounded-lg text-sm" placeholder="Capital">
                            </div>
                            <div>
                                <label for="export" class="block text-xs font-medium text-slate-400">Main Export</label>
                                <input type="text" id="export" name="export" class="w-full p-2 rounded-lg text-sm" placeholder="Export">
                            </div>
                        </div>

                        <!-- Row 3 - Large Inputs -->
                        <div>
                            <label for="unique" class="block text-xs font-medium text-slate-400">Unique Trait / Short History</label>
                            <textarea id="unique" name="unique" rows="3" class="w-full p-2 rounded-lg text-sm" placeholder="Describe a unique national trait or short history point..."></textarea>
                        </div>
                        
                        <button type="button" onclick="window.saveWorldToPlayer()" class="btn-primary w-full p-3 rounded-lg mt-4">
                            <i class="fa-solid fa-floppy-disk mr-2"></i> Realm Save Data
                        </button>
                    </form>
                </div>
            </div>

            <!-- Column 2: Actions & Utilities -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Research & Crafting -->
                <div class="card p-4 rounded-xl grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Research Block -->
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-white border-b border-slate-600 pb-2"><i class="fa-solid fa-flask mr-2 text-indigo-400"></i> Research Lab (-2 Energy)</h2>
                        <label for="researcherSelect" class="block text-sm font-medium text-slate-300 mb-1">Researcher</label>
                        <select id="researcherSelect" onchange="window.updateSelects()" class="w-full p-2 rounded-lg text-sm mb-3"></select>
                        <button onclick="window.conductResearch()" class="bg-indigo-600 text-white font-bold w-full p-3 rounded-lg shadow-md hover:bg-indigo-500 transition">
                            <i class="fa-solid fa-arrow-up-right-dots mr-2"></i> Conduct Research (+1 Tech)
                        </button>
                    </div>

                    <!-- Crafting Block -->
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-white border-b border-slate-600 pb-2"><i class="fa-solid fa-wrench mr-2 text-orange-400"></i> Crafting Workshop (-5 Energy)</h2>
                        <label for="crafterSelect" class="block text-sm font-medium text-slate-300 mb-1">Crafter (Needs T3+)</label>
                        <select id="crafterSelect" onchange="window.updateSelects()" class="w-full p-2 rounded-lg text-sm mb-3"></select>
                        <label for="schematicInput" class="block text-sm font-medium text-slate-300 mb-1">Schematic Name</label>
                        <input type="text" id="schematicInput" class="w-full p-2 rounded-lg text-sm mb-3" placeholder="e.g. Plasma Blaster">
                        <p class="text-xs text-slate-500 mb-3"><i class="fa-solid fa-cube mr-1"></i> Required: 1 x <span id="craftingStatus" class="font-bold text-yellow-300">Resource: None</span></p>
                        <button onclick="window.craftItem()" class="bg-orange-600 text-white font-bold w-full p-3 rounded-lg shadow-md hover:bg-orange-500 transition">
                            <i class="fa-solid fa-hammer mr-2"></i> Craft Item
                        </button>
                    </div>
                </div>

                <!-- Battle Simulator -->
                <div class="card p-4 rounded-xl">
                    <h2 class="text-xl font-semibold mb-3 text-white"><i class="fa-solid fa-fist-raised mr-2 text-red-400"></i> Battle Simulator</h2>
                    <div class="flex space-x-2 mb-4">
                        <button id="btn1v1" onclick="window.switchBattleMode('1v1')" class="flex-1 p-2 rounded-lg text-sm bg-yellow-600 text-white font-bold transition">1 vs 1</button>
                        <button id="btn2v2" onclick="window.switchBattleMode('2v2')" class="flex-1 p-2 rounded-lg text-sm bg-slate-700 text-slate-300 transition">2 vs 2</button>
                    </div>

                    <!-- 1v1 GUI -->
                    <div id="battleGUI_1v1" class="space-y-4">
                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="p1Select" class="block text-sm font-medium text-slate-300 mb-1">Player 1 (P1)</label>
                                <select id="p1Select" onchange="window.updateBattleOdds()" class="w-full p-2 rounded-lg text-sm"></select>
                            </div>
                            <div class="flex-1">
                                <label for="p2Select" class="block text-sm font-medium text-slate-300 mb-1">Player 2 (P2)</label>
                                <select id="p2Select" onchange="window.updateBattleOdds()" class="w-full p-2 rounded-lg text-sm"></select>
                            </div>
                        </div>

                        <div class="flex justify-between items-center bg-slate-700 p-3 rounded-lg font-mono text-lg">
                            <span id="p1Score" class="text-green-400">0</span>
                            <span id="oddsDisplay" class="text-slate-400 text-sm">Odds: P1 (50%) vs P2 (50%)</span>
                            <span id="p2Score" class="text-red-400">0</span>
                        </div>

                        <div id="coin" class="cursor-pointer" onclick="window.battleFlip()">
                            <div class="coin-face front"><i class="fa-solid fa-crown text-3xl"></i></div>
                            <div class="coin-face back"><i class="fa-solid fa-skull text-3xl"></i></div>
                        </div>

                        <p id="battleResult" class="text-center text-yellow-400 font-bold h-6"></p>

                        <button onclick="window.resetBattle()" class="bg-slate-600 text-white w-full p-2 rounded-lg text-sm hover:bg-slate-500 transition">Reset Score</button>
                    </div>
                    
                    <!-- 2v2 GUI -->
                    <div id="battleGUI_2v2" class="space-y-4 hidden">
                         <div class="grid grid-cols-2 gap-4">
                            <!-- Team 1 (Blue) -->
                            <div class="card p-3 rounded-lg border-2 border-blue-600 bg-blue-900/30">
                                <h3 class="text-lg font-bold text-blue-300 mb-2">Team 1</h3>
                                <select id="t1p1Select" onchange="window.updateDuoBattleOdds()" class="w-full p-2 rounded-lg text-sm mb-2"></select>
                                <select id="t1p2Select" onchange="window.updateDuoBattleOdds()" class="w-full p-2 rounded-lg text-sm"></select>
                            </div>
                            <!-- Team 2 (Red) -->
                            <div class="card p-3 rounded-lg border-2 border-red-600 bg-red-900/30">
                                <h3 class="text-lg font-bold text-red-300 mb-2">Team 2</h3>
                                <select id="t2p1Select" onchange="window.updateDuoBattleOdds()" class="w-full p-2 rounded-lg text-sm mb-2"></select>
                                <select id="t2p2Select" onchange="window.updateDuoBattleOdds()" class="w-full p-2 rounded-lg text-sm"></select>
                            </div>
                        </div>

                        <div class="flex justify-between items-center bg-slate-700 p-3 rounded-lg font-mono text-lg">
                            <span id="t1Score" class="text-blue-400">0</span>
                            <span id="duoOddsDisplay" class="text-slate-400 text-sm">Odds: Team 1 (50%) vs Team 2 (50%)</span>
                            <span id="t2Score" class="text-red-400">0</span>
                        </div>

                        <div id="duoCoin" class="cursor-pointer" onclick="window.duoBattleFlip()">
                            <div class="coin-face front bg-blue-600">T1</div>
                            <div class="coin-face back bg-red-600">T2</div>
                        </div>
                        
                        <p id="duoBattleResult" class="text-center text-yellow-400 font-bold h-6"></p>

                        <button onclick="window.resetDuoBattle()" class="bg-slate-600 text-white w-full p-2 rounded-lg text-sm hover:bg-slate-500 transition">Reset Score</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>