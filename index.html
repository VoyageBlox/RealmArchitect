<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realm Architect: Multiplayer Edition</title>
    <!-- Tailwind CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght[300;400;600]&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark Slate Gray */
            color: #d1d5db; /* Light Gray */
            overflow-x: hidden;
            position: relative;
        }
        .cinzel {
            font-family: 'Cinzel', serif;
        }
        .card {
            background-color: #374151; /* Medium Slate Gray */
            border: 1px solid #4b5563; /* Border */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #f59e0b; /* Amber */
            color: #1f2937;
            font-weight: bold;
            transition: all 0.15s;
        }
        .btn-primary:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .coin-face {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #coin, #duoCoin {
            width: 80px;
            height: 80px;
            margin: 20px auto;
            transform-style: preserve-3d;
            perspective: 1000px;
            transition: transform 1.5s cubic-bezier(0.4, 2.5, 0.55, 0.5);
        }
        #coin .front { background-color: #10b981; transform: rotateY(0deg); } /* Green (Heads) */
        #coin .back { background-color: #ef4444; transform: rotateY(180deg); } /* Red (Tails) */
        #duoCoin .front { background-color: #3b82f6; transform: rotateY(0deg); } /* Blue (Heads) - Team 1 */
        #duoCoin .back { background-color: #ef4444; transform: rotateY(180deg); } /* Red (Tails) - Team 2 */
        
        input[type="text"], select, textarea {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #f3f4f6;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 1px #f59e0b;
        }

        /* --- WONKY BACKGROUND STYLES --- */
        .cube-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background-color: #0d1117;
        }
        
        .shape {
            position: absolute;
            transform-style: preserve-3d;
            opacity: 0.2; /* Increased Opacity */
        }
        
        /* CUBE Styles */
        .cube {
            width: 50px;
            height: 50px;
            animation: floatAndRotate 20s infinite ease-in-out;
        }
        .cube-face {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.15); /* Brighter */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Brighter */
        }
        .cube-face.front  { transform: rotateY(0deg) translateZ(25px); }
        .cube-face.back   { transform: rotateX(180deg) translateZ(25px); }
        .cube-face.right  { transform: rotateY(90deg) translateZ(25px); }
        .cube-face.left   { transform: rotateY(-90deg) translateZ(25px); }
        .cube-face.top    { transform: rotateX(90deg) translateZ(25px); }
        .cube-face.bottom { transform: rotateX(-90deg) translateZ(25px); }

        /* TRIANGLE Styles */
        .triangle {
            width: 0;
            height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-bottom: 86.6px solid rgba(168, 85, 247, 0.2); /* Fuchsia/Purple (Brighter) */
            animation: wonkyTriangle 15s infinite linear;
            filter: blur(1px);
        }
        
        /* CIRCLE/SWIRL Styles */
        .swirl {
            width: 70px;
            height: 70px;
            background: transparent;
            border: 5px solid;
            border-color: rgba(245, 158, 11, 0.2) transparent rgba(245, 158, 11, 0.2) transparent; /* Amber (Brighter) */
            border-radius: 50%;
            animation: swirlRotate 25s infinite linear;
        }

        /* KEYFRAMES */
        @keyframes floatAndRotate {
            0% { transform: translate(0, 0) rotateX(0deg) rotateY(0deg); }
            25% { transform: translate(10vw, 5vw) rotateX(90deg) rotateY(45deg); }
            50% { transform: translate(0, 10vw) rotateX(180deg) rotateY(90deg); }
            75% { transform: translate(-10vw, 5vw) rotateX(270deg) rotateY(135deg); }
            100% { transform: translate(0, 0) rotateX(360deg) rotateY(180deg); }
        }

        @keyframes wonkyTriangle {
            0% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(20vw, 15vh) rotate(120deg) scale(0.8); }
            66% { transform: translate(5vw, 30vh) rotate(240deg) scale(1.1); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        
        @keyframes swirlRotate {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(0.9); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        /* Ensure content is above the background */
        .content-container {
            position: relative;
            z-index: 1;
        }

    </style>
    
    <!-- ⚠️ YOUR FIREBASE CONFIGURATION ⚠️ -->
    <script>
        // GLOBAL VARIABLES PROVIDED BY THE CANVAS ENVIRONMENT
        // These variables MUST be used for Firebase configuration and authentication.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Global state variables
        window.db = null;
        window.auth = null;
        window.localPlayerId = null;
        window.players = [];
        window.battleState = { p1: 0, p2: 0, lastBattleId: 0, result: null, winner: null };
        window.duoBattleState = { t1: 0, t2: 0, lastBattleId: 0, result: null, winner: null };
        
        // Utility function to show a notification message
        window.showNotification = (message, className) => {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-[99] p-4 rounded-lg shadow-xl text-white font-bold transition-all duration-300 ${className}`;
            notification.innerHTML = `<i class="fa-solid fa-bell mr-2"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.classList.remove('top-4');
                notification.classList.add('top-0');
                setTimeout(() => notification.remove(), 500);
            }, 5000); 
        };

    </script>
    
    <!-- Firebase Imports and Main Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, setLogLevel, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('debug');

        // --- CORE FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                // 1. Sign in using custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                // 2. Set up auth listener to get the final user ID
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.localPlayerId = user.uid;
                        document.getElementById('userIdDisplay').innerText = user.uid;
                        document.getElementById('authStatus').innerText = 'Online';
                        document.getElementById('authStatus').classList.add('text-green-400');
                        document.getElementById('authStatus').classList.remove('text-red-400');
                        
                        // 3. Start listening to live data once authenticated
                        listenToGameData();
                    } else {
                        window.localPlayerId = null;
                        document.getElementById('authStatus').innerText = 'Offline';
                        document.getElementById('authStatus').classList.remove('text-green-400');
                        document.getElementById('authStatus').classList.add('text-red-400');
                        document.getElementById('userIdDisplay').innerText = 'N/A';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification(`Initialization failed: ${error.message}`, 'bg-red-800');
            }
        }

        // --- FIRESTORE DATA PATHS ---
        const gameDataPath = `artifacts/${appId}/public/data/game-state`;
        const gameDocRef = (db) => doc(db, gameDataPath, 'state');

        // --- FIRESTORE WRITE OPERATION (Saves ALL state: players, 1v1 battle, 2v2 battle) ---
        window.saveToDb = async (newPlayers, newBattleState = window.battleState, newDuoBattleState = window.duoBattleState) => {
            if (!window.db || !window.localPlayerId) {
                showNotification("Database not ready or player ID missing!", 'bg-red-600');
                return false;
            }

            try {
                // The current player must ensure their data exists and is up-to-date
                const currentPlayer = newPlayers.find(p => p.id === window.localPlayerId);
                if (!currentPlayer) {
                     // If the current player is missing, re-add them
                     const defaultPlayer = createNewPlayer(window.localPlayerId, window.auth.currentUser.email || `Player_${window.localPlayerId.substring(0, 4)}`);
                     newPlayers.push(defaultPlayer);
                     showNotification("Local player state was missing and has been re-created.", 'bg-orange-500');
                }
                
                const dataToSave = {
                    players: newPlayers,
                    battleState: newBattleState,
                    duoBattleState: newDuoBattleState,
                    lastModified: Date.now()
                };

                // Use setDoc to overwrite the entire document state (or create it if it doesn't exist)
                await setDoc(gameDocRef(window.db), dataToSave);
                return true;
            } catch (error) {
                console.error("Error saving game state:", error);
                showNotification(`Save failed: ${error.message}`, 'bg-red-600');
                return false;
            }
        };

        // --- FIRESTORE READ OPERATION (Real-time listener) ---
        function listenToGameData() {
            if (!window.db || !window.localPlayerId) return;

            onSnapshot(gameDocRef(window.db), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    const oldPlayers = window.players;
                    const oldBattleId = window.battleState.lastBattleId;
                    const oldDuoBattleId = window.duoBattleState.lastBattleId;
                    
                    window.players = data.players || [];
                    window.battleState = data.battleState || window.battleState;
                    window.duoBattleState = data.duoBattleState || window.duoBattleState;

                    // Check if local player exists, if not, automatically create and save them.
                    const localPlayerInState = window.players.find(p => p.id === window.localPlayerId);
                    if (!localPlayerInState) {
                        console.warn("Local player not found in state, auto-creating...");
                        const defaultPlayer = createNewPlayer(window.localPlayerId, window.auth.currentUser.email || `Player_${window.localPlayerId.substring(0, 4)}`);
                        window.players.push(defaultPlayer);
                        window.saveToDb(window.players); // Trigger a save to add the new player
                    }
                    
                    // Update UI elements based on new data
                    window.renderPlayers();
                    window.updateSelects(); // Re-populate dropdowns
                    window.loadWorldData(); // Load current player's world data into form
                    
                    // --- Battle Animation Trigger ---
                    if (window.battleState.lastBattleId > oldBattleId) {
                        window.triggerBattleAnimation(window.battleState, 'coin', 'flipResultDisplay', false);
                    }
                    if (window.duoBattleState.lastBattleId > oldDuoBattleId) {
                        window.triggerBattleAnimation(window.duoBattleState, 'duoCoin', 'duoFlipResultDisplay', true);
                    }
                    
                    // Update scoreboards
                    document.getElementById('scoreP1').innerText = window.battleState.p1;
                    document.getElementById('scoreP2').innerText = window.battleState.p2;
                    document.getElementById('scoreT1').innerText = window.duoBattleState.t1;
                    document.getElementById('scoreT2').innerText = window.duoBattleState.t2;

                } else {
                    console.warn("Game state document does not exist, creating default state.");
                    // Initialize the document with the local player
                    const initialPlayer = createNewPlayer(window.localPlayerId, window.auth.currentUser.email || `Player_${window.localPlayerId.substring(0, 4)}`);
                    window.saveToDb([initialPlayer]); 
                }
            }, (error) => {
                console.error("Firestore listen failed:", error);
                showNotification(`Data stream error: ${error.message}`, 'bg-red-800');
            });
        }

        // --- PLAYER CREATION HELPER ---
        function createNewPlayer(id, name) {
            return {
                id: id,
                name: name.split('@')[0].substring(0, 10), // Use first part of email or generated name
                energy: 10,
                techLevel: 1,
                inventory: ["Simple Tool Kit"],
                worldData: {
                    terrain: 'Plains',
                    resources: 'None',
                    climate: 'Temperate',
                    countryName: '',
                    capitalCity: '',
                    language: '',
                    export: '',
                    culture: '',
                    history: '',
                    unique: ''
                },
                lastUpdate: Date.now()
            };
        }
        
        // --- Game Logic functions (moved from the script tag into window) ---

        window.renderPlayers = () => {
            const list = document.getElementById('playerList');
            const currentPlayers = window.players || [];
            
            if (currentPlayers.length === 0) {
                list.innerHTML = '<li class="text-slate-500 text-center text-sm p-4">Waiting for players to join...</li>';
                return;
            }

            const sortedPlayers = [...currentPlayers].sort((a, b) => b.techLevel - a.techLevel);
            
            list.innerHTML = sortedPlayers.map(p => `
                <li class="p-3 bg-slate-700/50 rounded-lg flex justify-between items-center border border-slate-600 shadow-md">
                    <div class="flex items-center space-x-3">
                        <i class="fa-solid fa-user-circle text-lg ${p.id === localPlayerId ? 'text-green-400' : 'text-slate-400'}"></i>
                        <span class="font-bold ${p.id === localPlayerId ? 'text-white' : 'text-slate-200'}">${p.name} ${p.id === localPlayerId ? '(You)' : ''}</span>
                    </div>
                    <div class="text-right text-sm">
                        <span class="text-yellow-400 font-mono">⚡${p.energy}</span>
                        <span class="text-indigo-400 ml-3">Tech: ${p.techLevel}</span>
                        ${p.inventory && p.inventory.length > 0 ? `<span class="ml-3 text-red-300">⚔️ ${p.inventory.length} items</span>` : ''}
                    </div>
                </li>
            `).join('');
            
            const currentPlayer = currentPlayers.find(p => p.id === localPlayerId);
            if(currentPlayer) {
                document.getElementById('myEnergyDisplay').innerText = currentPlayer.energy;
                document.getElementById('myTechLevelDisplay').innerText = currentPlayer.techLevel;
            }

            // Also update the World Data Preview if available
            const worldPreview = document.getElementById('worldDataPreview');
            if (currentPlayer && currentPlayer.worldData && currentPlayer.worldData.countryName) {
                const data = currentPlayer.worldData;
                worldPreview.innerHTML = `
                    <p class="text-sm font-bold text-slate-100 mb-1">${data.countryName || 'Untitled Country'}</p>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                        <p class="text-slate-400"><i class="fa-solid fa-mountain-sun mr-1"></i> Terrain: ${data.terrain}</p>
                        <p class="text-slate-400"><i class="fa-solid fa-cloud-sun-rain mr-1"></i> Climate: ${data.climate}</p>
                        <p class="text-slate-400"><i class="fa-solid fa-gem mr-1"></i> Resources: ${data.resources}</p>
                        <p class="text-slate-400"><i class="fa-solid fa-arrow-right-arrow-left mr-1"></i> Export: ${data.export}</p>
                    </div>
                    <p class="text-xs text-slate-500 italic mt-2">${data.unique ? data.unique.substring(0, 50) + '...' : 'No unique trait defined.'}</p>
                `;
            } else {
                worldPreview.innerHTML = '<p class="text-xs text-slate-500 italic">No world data saved yet. Fill out the form below to create your country!</p>';
            }
        };
        
        // --- NEW FUNCTION TO LOAD LIVE DATA INTO THE FORM ---
        window.loadWorldData = () => {
            const currentPlayer = window.players.find(p => p.id === localPlayerId);
            const formElements = document.getElementById('worldForm')?.elements;
            if (!formElements) return;

            // Check if player data is available
            if (!currentPlayer || !currentPlayer.worldData || !currentPlayer.worldData.countryName) {
                document.getElementById('worldForm').reset();
                formElements.resources.value = 'None'; 
                formElements.terrain.value = 'Plains';
                formElements.climate.value = 'Temperate';
            } else {
                const data = currentPlayer.worldData;
                formElements.terrain.value = data.terrain || 'Plains';
                formElements.resources.value = data.resources || 'None';
                formElements.climate.value = data.climate || 'Temperate';
                formElements.countryName.value = data.countryName || '';
                formElements.capitalCity.value = data.capitalCity || '';
                // The elements below are now assumed to exist in HTML
                formElements.language.value = data.language || '';
                formElements.export.value = data.export || '';
                formElements.culture.value = data.culture || '';
                formElements.history.value = data.history || '';
                formElements.unique.value = data.unique || '';
            }

            window.checkCraftingOptions();
        };

        window.updateSelects = () => {
            const currentPlayers = window.players || [];
            const playerOptions = currentPlayers.map(p => `<option value="${p.id}">${p.name} (T${p.techLevel})</option>`).join('');
            
            const updateSelect = (id, defaultText) => {
                const el = document.getElementById(id);
                if (!el) return;
                const currentVal = el.value;
                el.innerHTML = `<option value="">${defaultText}</option>` + playerOptions;
                if (currentVal && currentPlayers.find(p => p.id === currentVal)) {
                    el.value = currentVal;
                }
            };

            updateSelect('p1Select', 'P1 - Select Player');
            updateSelect('p2Select', 'P2 - Select Player');
            updateSelect('researcherSelect', 'Select Researcher');
            updateSelect('crafterSelect', 'Select Crafter');
            updateSelect('t1p1Select', 'Team 1 (P1)');
            updateSelect('t1p2Select', 'Team 1 (P2)');
            updateSelect('t2p1Select', 'Team 2 (P1)');
            updateSelect('t2p2Select', 'Team 2 (P2)');

            window.updateBattleOdds();
            window.updateDuoBattleOdds();
            window.checkCraftingOptions();
        };

        window.findPlayerById = (id) => (window.players || []).find(p => p.id === id);

        // Logic for World Data Save (Realm Save Data button fix)
        window.saveWorldToPlayer = async () => {
            if (!localPlayerId) return showNotification("You are not logged in!", 'bg-red-600');
            
            const currentPlayer = window.players.find(p => p.id === localPlayerId);
            if (!currentPlayer) {
                console.error("Local player object not found in window.players array.", localPlayerId, window.players);
                // Attempt to re-create the player if not found in the state
                const defaultPlayer = createNewPlayer(window.localPlayerId, window.auth.currentUser.email || `Player_${window.localPlayerId.substring(0, 4)}`);
                window.players.push(defaultPlayer);
                return showNotification("Player object re-created. Try saving again.", 'bg-orange-600');
            }

            const formElements = document.getElementById('worldForm').elements;
            const worldData = {
                terrain: formElements.terrain.value,
                resources: formElements.resources.value,
                climate: formElements.climate.value,
                countryName: formElements.countryName.value,
                capitalCity: formElements.capitalCity.value,
                // These elements are now correctly retrieved from the form
                language: formElements.language.value, 
                export: formElements.export.value,
                culture: formElements.culture.value,
                history: formElements.history.value,
                // End of new elements
                unique: formElements.unique.value,
            };

            // 1. Update ONLY the current player's entry in the global array
            const updatedPlayers = window.players.map(p => {
                if (p.id === localPlayerId) {
                    return { 
                        ...p, 
                        worldData: worldData, // Saved from the form
                        lastUpdate: Date.now()
                    };
                }
                return p;
            });

            // 2. Save the whole updated array back to Firestore
            const success = await window.saveToDb(updatedPlayers);
            if (success) {
                showNotification("World Data Saved Successfully!", 'bg-green-600');
            }
        };

        window.conductResearch = async () => {
            const playerId = document.getElementById('researcherSelect').value;
            if (!playerId) return showNotification("Select a researcher!", 'bg-red-600');
            const player = window.findPlayerById(playerId);
            if (!player) return showNotification("Player not found!", 'bg-red-600');
            // Client-side security check: only the local player can initiate this action for themselves
            if (player.id !== localPlayerId) return showNotification("You can only research for yourself!", 'bg-red-600');
            if (player.energy < 2) return showNotification(`${player.name} needs 2 Energy to research!`, 'bg-red-600');

            const index = window.players.findIndex(p => p.id === playerId);
            const updatedPlayers = [...window.players];
            updatedPlayers[index].energy -= 2;
            updatedPlayers[index].techLevel += 1;
            updatedPlayers[index].lastUpdate = Date.now();

            const success = await window.saveToDb(updatedPlayers);
            if (success) {
                showNotification(`${player.name} researched new tech! Tech Level is now ${updatedPlayers[index].techLevel}.`, 'bg-indigo-600');
            }
        };

        // --- UPDATED CRAFT ITEM LOGIC ---
        window.craftItem = async () => {
            const playerId = document.getElementById('crafterSelect').value;
            const schematic = document.getElementById('schematicInput').value.trim();
            const requiredResource = document.getElementById('worldForm')?.elements?.resources?.value;
            
            if (!playerId) return showNotification("Select a crafter!", 'bg-red-600');
            if (!schematic) return showNotification("Enter a schematic name!", 'bg-red-600');
            if (requiredResource === 'None' || !requiredResource) return showNotification("Set a primary world resource first in Realm Data!", 'bg-red-600');
            
            const player = window.findPlayerById(playerId);
            if (!player) return showNotification("Player not found!", 'bg-red-600');
            if (player.id !== localPlayerId) return showNotification("You can only craft for yourself!", 'bg-red-600');
            if (player.energy < 5) return showNotification(`${player.name} needs 5 Energy to craft!`, 'bg-red-600');
            if (player.techLevel < 1) return showNotification(`${player.name} needs Tech Level 1 to craft complex items!`, 'bg-red-600');

            const lowerSchematic = schematic.toLowerCase();

            // 1. OP Item Detection (Blacklist)
            const opBlacklist = ['godly', 'infinite', 'nuclear', 'perfect', 'ultimate', 'cheat', 'impenetrable', 'instant win'];
            if (opBlacklist.some(word => lowerSchematic.includes(word))) {
                return showNotification(`Crafting failed: Schematic contains an overpowered keyword ("${schematic}").`, 'bg-red-600');
            }

            // 2. Tech Progression Check 
            const techLevel = player.techLevel;
            let blocked = false;
            let reason = '';

            if (techLevel < 2 && (lowerSchematic.includes('steel') || lowerSchematic.includes('iron') || lowerSchematic.includes('metal'))) {
                blocked = true;
                reason = 'Requires Tech Level 2 for basic metallurgy (Iron/Steel).';
            } else if (techLevel < 3 && (lowerSchematic.includes('gun') || lowerSchematic.includes('bomb') || lowerSchematic.includes('engine') || lowerSchematic.includes('industrial'))) {
                blocked = true;
                reason = 'Requires Tech Level 3 for basic industrial schematics.';
            } else if (techLevel < 4 && (lowerSchematic.includes('laser') || lowerSchematic.includes('plasma') || lowerSchematic.includes('computer') || lowerSchematic.includes('ai'))) {
                blocked = true;
                reason = 'Requires Tech Level 4 for advanced schematics.';
            }

            if (blocked) {
                return showNotification(`Crafting failed: ${reason} (Current Tech: ${techLevel})`, 'bg-orange-600');
            }
            
            const index = window.players.findIndex(p => p.id === playerId);
            const updatedPlayers = [...window.players];
            updatedPlayers[index].energy -= 5;
            updatedPlayers[index].inventory.push(`${schematic} (${requiredResource})`);
            updatedPlayers[index].lastUpdate = Date.now();

            const success = await window.saveToDb(updatedPlayers);
            if (success) {
                showNotification(`${player.name} crafted ${schematic} using ${requiredResource}!`, 'bg-green-600');
            }
        };

        window.checkCraftingOptions = () => {
            const resource = document.getElementById('worldForm')?.elements?.resources?.value || 'None';
            document.getElementById('craftingStatus').innerText = `Resource: ${resource}`;
        };

        window.updateBattleOdds = () => {
            const p1Id = document.getElementById('p1Select').value;
            const p2Id = document.getElementById('p2Select').value;
            const p1 = window.findPlayerById(p1Id);
            const p2 = window.findPlayerById(p2Id);
            
            let p1Level = p1 ? p1.techLevel : 0;
            let p2Level = p2 ? p2.techLevel : 0;

            if (p1Id === p2Id && p1Id !== "") {
                document.getElementById('oddsDisplay').innerText = "ERROR: Cannot battle yourself!";
                return;
            }

            let diff = p1Level - p2Level;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 5);
            let p1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);
            let p2Odd = 100 - p1Odd;
            document.getElementById('oddsDisplay').innerText = `Odds: ${p1 ? p1.name : 'P1'} (${p1Odd}%) vs ${p2 ? p2.name : 'P2'} (${p2Odd}%)`;
        };

        window.battleFlip = async () => {
            const p1Id = document.getElementById('p1Select').value;
            const p2Id = document.getElementById('p2Select').value;
            const p1 = window.findPlayerById(p1Id);
            const p2 = window.findPlayerById(p2Id);
            if (!p1 || !p2 || p1Id === p2Id) {
                return showNotification("Select two unique players for the battle!", 'bg-red-600');
            }
            // Check if the current user is one of the players involved, or if both have enough energy
            if (p1.id !== localPlayerId && p2.id !== localPlayerId) {
                 return showNotification("Only an involved player can initiate the flip!", 'bg-red-600');
            }
            if (p1.energy < 1 || p2.energy < 1) {
                return showNotification("Both players need 1 Energy to battle!", 'bg-red-600');
            }

            let diff = p1.techLevel - p2.techLevel;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 5);
            let p1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);

            const coin = document.getElementById('coin');
            coin.style.transition = 'none';
            coin.style.transform = 'rotateY(0deg)';
            await new Promise(resolve => setTimeout(resolve, 50));

            const random = Math.random() * 100;
            const winnerId = (random < p1Odd) ? p1Id : p2Id;
            const flipResult = (winnerId === p1Id) ? 'heads' : 'tails';

            // Apply energy cost immediately to the local player's data before saving
            const updatedPlayers = window.players.map(p => {
                if (p.id === p1Id) {
                    p.energy = Math.max(0, p.energy - 1);
                }
                if (p.id === p2Id) {
                    p.energy = Math.max(0, p.energy - 1);
                }
                return p;
            });
            
            // Apply energy gain to the winner
            const winnerIndex = updatedPlayers.findIndex(p => p.id === winnerId);
            if (winnerIndex !== -1) {
                updatedPlayers[winnerIndex].energy = Math.max(0, updatedPlayers[winnerIndex].energy + 1); // 1 Energy prize
            }

            const newBattleState = {
                ...window.battleState,
                lastBattleId: window.battleState.lastBattleId + 1,
                result: flipResult,
                winner: winnerId
            };
            if (winnerId === p1Id) {
                newBattleState.p1 += 1;
            } else {
                newBattleState.p2 += 1;
            }
            const success = await window.saveToDb(updatedPlayers, newBattleState);
            if (success) {
                // Animation will be triggered by onSnapshot
                showNotification(`Battle initiated by ${window.findPlayerById(localPlayerId).name}!`, 'bg-gray-700');
            }
        };

        window.updateDuoBattleOdds = () => {
            const t1p1 = window.findPlayerById(document.getElementById('t1p1Select').value);
            const t1p2 = window.findPlayerById(document.getElementById('t1p2Select').value);
            const t2p1 = window.findPlayerById(document.getElementById('t2p1Select').value);
            const t2p2 = window.findPlayerById(document.getElementById('t2p2Select').value);
            let t1Level = (t1p1 ? t1p1.techLevel : 0) + (t1p2 ? t1p2.techLevel : 0);
            let t2Level = (t2p1 ? t2p1.techLevel : 0) + (t2p2 ? t2p2.techLevel : 0);
            
            const allPlayers = [t1p1, t1p2, t2p1, t2p2].filter(p => p);
            const playerIds = allPlayers.map(p => p.id);
            if (new Set(playerIds).size !== playerIds.length) {
                document.getElementById('duoOddsDisplay').innerText = "ERROR: Duplicate players detected!";
                return;
            }

            let diff = t1Level - t2Level;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 3);
            let t1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);
            let t2Odd = 100 - t1Odd;
            document.getElementById('duoOddsDisplay').innerText = `Odds: Team 1 (${t1Odd}%) vs Team 2 (${t2Odd}%)`;
        };

        window.duoBattleFlip = async () => {
            const t1p1 = window.findPlayerById(document.getElementById('t1p1Select').value);
            const t1p2 = window.findPlayerById(document.getElementById('t1p2Select').value);
            const t2p1 = window.findPlayerById(document.getElementById('t2p1Select').value);
            const t2p2 = window.findPlayerById(document.getElementById('t2p2Select').value);
            
            const t1Ids = [t1p1?.id, t1p2?.id].filter(Boolean);
            const t2Ids = [t2p1?.id, t2p2?.id].filter(Boolean);
            const allPlayers = [t1p1, t1p2, t2p1, t2p2].filter(p => p);

            if (t1Ids.length === 0 || t2Ids.length === 0) { 
                return showNotification("Select at least one player for each team!", 'bg-red-600');
            }
            if (!allPlayers.some(p => p.id === localPlayerId)) {
                return showNotification("You must be part of one of the teams to initiate the flip!", 'bg-red-600');
            }

            // Check Energy Cost (2 Energy per player)
            for (const player of allPlayers) {
                if (player.energy < 2) {
                    return showNotification(`Player ${player.name} needs 2 Energy to battle!`, 'bg-red-600');
                }
            }

            let t1Level = (t1p1 ? t1p1.techLevel : 0) + (t1p2 ? t1p2.techLevel : 0);
            let t2Level = (t2p1 ? t2p1.techLevel : 0) + (t2p2 ? t2p2.techLevel : 0);
            let diff = t1Level - t2Level;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 3);
            let t1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);
            
            const coin = document.getElementById('duoCoin');
            coin.style.transition = 'none';
            coin.style.transform = 'rotateY(0deg)';
            await new Promise(resolve => setTimeout(resolve, 50));
            
            const random = Math.random() * 100;
            const winnerTeam = (random < t1Odd) ? 't1' : 't2';
            const flipResult = (winnerTeam === 't1') ? 'heads' : 'tails';

            // Apply energy cost and gain immediately
            const updatedPlayers = window.players.map(p => {
                if (t1Ids.includes(p.id) || t2Ids.includes(p.id)) {
                    // All participants pay 2 energy cost
                    p.energy = Math.max(0, p.energy - 2); 
                }
                return p;
            });
            
            // Winner team gains 1 energy per member
            const winnerIds = winnerTeam === 't1' ? t1Ids : t2Ids;
            updatedPlayers.forEach(p => {
                if (winnerIds.includes(p.id)) {
                    p.energy += 1; 
                }
            });


            const newDuoBattleState = {
                ...window.duoBattleState,
                lastBattleId: window.duoBattleState.lastBattleId + 1,
                result: flipResult,
                winner: winnerTeam
            };
            if (winnerTeam === 't1') {
                newDuoBattleState.t1 += 1;
            } else {
                newDuoBattleState.t2 += 1;
            }
            const success = await window.saveToDb(updatedPlayers, window.battleState, newDuoBattleState);
            if (success) {
                // Animation will be triggered by onSnapshot
                showNotification(`Duo Battle initiated by ${window.findPlayerById(localPlayerId).name}!`, 'bg-gray-700');
            }
        };

        window.resetBattle = async () => {
            const newBattleState = { p1: 0, p2: 0, lastBattleId: window.battleState.lastBattleId, result: null, winner: null };
            const success = await window.saveToDb(window.players, newBattleState, window.duoBattleState);
            if (success) {
                showNotification("1v1 Score Reset!", 'bg-slate-600');
            }
        };

        window.resetDuoBattle = async () => {
            const newDuoBattleState = { t1: 0, t2: 0, lastBattleId: window.duoBattleState.lastBattleId, result: null, winner: null };
            const success = await window.saveToDb(window.players, window.battleState, newDuoBattleState);
              if (success) {
                showNotification("2v2 Score Reset!", 'bg-slate-600');
            }
        };

        window.triggerBattleAnimation = (newState, coinId, resultDisplayId, isDuo = false) => {
            const coin = document.getElementById(coinId);
            const resultDisplay = document.getElementById(resultDisplayId);
            
            // Determine names for display
            let team1Name = isDuo ? 'Team 1 (Blue)' : 'P1';
            let team2Name = isDuo ? 'Team 2 (Red)' : 'P2';
            const p1Select = document.getElementById('p1Select');
            const p2Select = document.getElementById('p2Select');

            if (!isDuo) {
                const p1 = window.findPlayerById(p1Select.value);
                const p2 = window.findPlayerById(p2Select.value);
                if (p1) team1Name = p1.name;
                if (p2) team2Name = p2.name;
            }
            
            coin.style.transition = 'none';
            coin.style.transform = 'rotateY(0deg)';
            void coin.offsetWidth; 
            coin.style.transition = 'transform 1.5s cubic-bezier(0.4, 2.5, 0.55, 0.5)';
            if (newState.result === 'heads') {
                coin.style.transform = 'rotateY(3600deg)';
            } else {
                coin.style.transform = 'rotateY(3780deg)'; // 3600 + 180
            }
            resultDisplay.innerText = 'Flipping...';

            setTimeout(() => {
                // Determine winner's name correctly based on the current state and selection
                let winnerText;
                if (isDuo) {
                    winnerText = (newState.winner === 't1') ? 'Team 1 (Blue)' : 'Team 2 (Red)';
                } else {
                    winnerText = (newState.winner === p1Select.value) ? team1Name : team2Name;
                }
                
                resultDisplay.innerHTML = `<span class="text-xl font-bold ${newState.result === 'heads' ? 'text-green-400' : 'text-red-400'}">${winnerText} WINS!</span><br><span class="text-sm text-slate-400">(${newState.result})</span>`;
                // showNotification(`${winnerText} won the battle!`, newState.result === 'heads' ? 'bg-green-600' : 'bg-red-600'); // Notification is removed as energy change handles it for 1v1 and flip handles it for 2v2
                
            }, 1500); // Match animation duration
        };

        // Initialize Firebase on window load
        window.onload = initializeFirebase;
    </script>
</head>
<body class="min-h-screen">

    <!-- Wonky Cube Background -->
    <div class="cube-background">
        <!-- Cube 1 -->
        <div class="shape cube absolute top-1/4 left-1/4" style="transform: perspective(500px) rotateX(45deg) rotateY(45deg);">
            <div class="cube-face front"></div>
            <div class="cube-face back"></div>
            <div class="cube-face right"></div>
            <div class="cube-face left"></div>
            <div class="cube-face top"></div>
            <div class="cube-face bottom"></div>
        </div>
        <!-- Triangle 1 -->
        <div class="shape triangle absolute top-3/4 left-1/2"></div>
         <!-- Swirl 1 -->
        <div class="shape swirl absolute top-1/2 right-1/4"></div>
    </div>

    <!-- Main Content Container -->
    <div class="content-container p-4 md:p-8 max-w-7xl mx-auto">
        
        <!-- Header -->
        <header class="text-center mb-10 border-b border-yellow-600/50 pb-4">
            <h1 class="cinzel text-5xl font-bold text-yellow-500">Realm Architect</h1>
            <p class="text-sm text-slate-400 mt-2">Multiplayer Edition | Cooperative World-Building & PvP</p>
            <div class="mt-4 text-xs font-mono flex flex-wrap justify-center items-center space-x-4">
                <span class="text-slate-400">User ID: <span id="userIdDisplay" class="text-slate-200">N/A</span></span>
                <span class="text-slate-400">Status: <span id="authStatus" class="text-red-400">Connecting...</span></span>
            </div>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Column 1: Player List and Stats -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Player Status Card -->
                <div class="card p-6 rounded-xl">
                    <h2 class="cinzel text-xl font-bold mb-4 text-yellow-400 border-b border-slate-600 pb-2">Your Architect Status</h2>
                    <div class="space-y-3">
                        <p class="flex justify-between items-center text-lg">
                            <span class="text-slate-300">Energy (Action Points):</span>
                            <span id="myEnergyDisplay" class="text-yellow-400 font-mono font-bold text-2xl">0</span>
                        </p>
                        <p class="flex justify-between items-center text-lg">
                            <span class="text-slate-300">Tech Level:</span>
                            <span id="myTechLevelDisplay" class="text-indigo-400 font-mono font-bold text-2xl">0</span>
                        </p>
                    </div>
                </div>

                <!-- Live Player List Card -->
                <div class="card p-6 rounded-xl">
                    <h2 class="cinzel text-xl font-bold mb-4 text-yellow-400 border-b border-slate-600 pb-2">Current Players</h2>
                    <ul id="playerList" class="space-y-3">
                        <!-- Player items generated by JS -->
                        <li class="text-slate-500 text-center text-sm p-4">Loading player data...</li>
                    </ul>
                </div>
            </div>

            <!-- Column 2: World Building & Actions -->
            <div class="lg:col-span-2 space-y-8">

                <!-- World Data Builder -->
                <div class="card p-6 rounded-xl">
                    <h2 class="cinzel text-2xl font-bold mb-4 text-yellow-400 flex justify-between items-center">
                        Realm Data Builder
                        <button onclick="window.loadWorldData()" class="text-xs btn-primary py-1 px-3 rounded-full flex items-center">
                             <i class="fa-solid fa-redo mr-2"></i> Load My Data
                        </button>
                    </h2>
                    
                    <!-- World Data Preview -->
                    <div id="worldDataPreview" class="bg-slate-800/50 p-4 rounded-lg mb-4 border border-slate-700">
                        <p class="text-xs text-slate-500 italic">Loading realm data...</p>
                    </div>

                    <form id="worldForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Country Name</label>
                                <input type="text" name="countryName" class="w-full p-2 rounded-lg" placeholder="e.g., The Glorious Empire of Aethelgard">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Capital City</label>
                                <input type="text" name="capitalCity" class="w-full p-2 rounded-lg" placeholder="e.g., Zenith">
                            </div>
                        </div>
                        
                        <!-- FIX: Adding the missing input fields for language, export, culture, and history -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Primary Language</label>
                                <input type="text" name="language" class="w-full p-2 rounded-lg" placeholder="e.g., Aethelian">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Primary Export</label>
                                <input type="text" name="export" class="w-full p-2 rounded-lg" placeholder="e.g., Rare Spice">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Core Culture</label>
                                <input type="text" name="culture" class="w-full p-2 rounded-lg" placeholder="e.g., Militaristic / Philosophical">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Key Historical Event</label>
                                <input type="text" name="history" class="w-full p-2 rounded-lg" placeholder="e.g., The Great Schism">
                            </div>
                        </div>
                        <!-- END FIX -->

                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Primary Terrain</label>
                                <select name="terrain" class="w-full p-2 rounded-lg" onchange="window.checkCraftingOptions()">
                                    <option value="Plains">Plains</option>
                                    <option value="Mountains">Mountains</option>
                                    <option value="Desert">Desert</option>
                                    <option value="Forest">Forest</option>
                                    <option value="Arctic">Arctic</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Primary Resource</label>
                                <select name="resources" id="resources" class="w-full p-2 rounded-lg" onchange="window.checkCraftingOptions()">
                                    <option value="None">-- Select --</option>
                                    <option value="Iron">Iron</option>
                                    <option value="Oil">Oil</option>
                                    <option value="Gems">Gems</option>
                                    <option value="Magic">Magic</option>
                                    <option value="Food">Food</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300">Primary Climate</label>
                                <select name="climate" class="w-full p-2 rounded-lg">
                                    <option value="Temperate">Temperate</option>
                                    <option value="Tropical">Tropical</option>
                                    <option value="Arid">Arid</option>
                                    <option value="Frozen">Frozen</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-300">Unique Trait / History Summary (2-3 sentences)</label>
                            <textarea name="unique" class="w-full p-2 rounded-lg" rows="2" placeholder="e.g., The country possesses ancient teleportation gates, but their use is unstable..."></textarea>
                        </div>

                        <div class="text-right pt-2">
                            <button type="button" onclick="window.saveWorldToPlayer()" class="btn-primary py-2 px-6 rounded-xl">
                                <i class="fa-solid fa-save mr-2"></i> Save Realm Data (Cost: 0 Energy)
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Action Hub -->
                <div class="card p-6 rounded-xl grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Research Action -->
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-indigo-400 border-b border-slate-600 pb-2">Research <span class="text-sm text-slate-400">(Cost: 2⚡, Gain: +1 Tech)</span></h3>
                        <p class="text-sm text-slate-400 mb-3">Invest Energy into technological advancement, increasing your overall power score.</p>
                        <select id="researcherSelect" class="w-full p-2 rounded-lg mb-4" onchange="window.updateSelects()">
                            <option value="">Select Researcher</option>
                        </select>
                        <button onclick="window.conductResearch()" class="btn-primary w-full py-2 px-4 rounded-xl">
                            <i class="fa-solid fa-flask mr-2"></i> Conduct Research
                        </button>
                    </div>

                    <!-- Crafting Action -->
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-red-400 border-b border-slate-600 pb-2">Crafting <span class="text-sm text-slate-400">(Cost: 5⚡)</span></h3>
                        <p class="text-sm text-slate-400 mb-3">Create a new item based on your Realm's Primary Resource.</p>
                        <div class="flex space-x-2 mb-3">
                            <select id="crafterSelect" class="w-1/2 p-2 rounded-lg" onchange="window.updateSelects()">
                                <option value="">Select Crafter</option>
                            </select>
                            <input type="text" id="schematicInput" class="w-1/2 p-2 rounded-lg" placeholder="Schematic Name">
                        </div>
                        <p id="craftingStatus" class="text-sm text-center text-yellow-500 mb-3">Resource: None</p>
                        <button onclick="window.craftItem()" class="btn-primary w-full py-2 px-4 rounded-xl">
                            <i class="fa-solid fa-hammer mr-2"></i> Craft Item
                        </button>
                    </div>
                </div>

                <!-- Battle Arena -->
                <div class="card p-6 rounded-xl">
                    <h2 class="cinzel text-2xl font-bold mb-4 text-yellow-400 border-b border-slate-600 pb-2">Battle Arena (PvP)</h2>

                    <!-- 1v1 Battle -->
                    <div class="mb-6 border border-slate-600 p-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-3 text-green-400">1v1 Showdown <span class="text-sm text-slate-400">(Cost: 1⚡ per player)</span></h3>
                        <div class="flex space-x-4 mb-4">
                            <select id="p1Select" class="w-1/2 p-2 rounded-lg" onchange="window.updateBattleOdds()">
                                <option value="">P1 - Select Player</option>
                            </select>
                            <select id="p2Select" class="w-1/2 p-2 rounded-lg" onchange="window.updateBattleOdds()">
                                <option value="">P2 - Select Player</option>
                            </select>
                        </div>
                        <p id="oddsDisplay" class="text-center text-lg font-bold text-slate-300 mb-4">Odds: P1 (50%) vs P2 (50%)</p>

                        <div class="flex items-center justify-center space-x-6">
                            <div class="text-center">
                                <span id="scoreP1" class="text-4xl cinzel text-green-400">0</span>
                                <p class="text-xs text-slate-400">P1 Score (Heads)</p>
                            </div>
                            <button onclick="window.battleFlip()" class="btn-primary py-3 px-6 rounded-full text-lg">
                                <i class="fa-solid fa-hand-fist mr-2"></i> Initiate Battle
                            </button>
                            <div class="text-center">
                                <span id="scoreP2" class="text-4xl cinzel text-red-400">0</span>
                                <p class="text-xs text-slate-400">P2 Score (Tails)</p>
                            </div>
                        </div>

                        <div id="coin" class="relative">
                            <div class="coin-face front"><i class="fa-solid fa-crown"></i></div>
                            <div class="coin-face back"><i class="fa-solid fa-skull"></i></div>
                        </div>

                        <div id="flipResultDisplay" class="text-center h-12 flex flex-col justify-center">
                            <!-- Flip result goes here -->
                        </div>
                        <button onclick="window.resetBattle()" class="w-full text-xs text-slate-500 hover:text-red-500 mt-2">Reset Score</button>
                    </div>

                    <!-- 2v2 Battle -->
                    <div class="border border-slate-600 p-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-3 text-blue-400">2v2 War <span class="text-sm text-slate-400">(Cost: 2⚡ per player)</span></h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Team 1 (Blue) -->
                            <div class="p-3 bg-blue-900/30 rounded-lg">
                                <h4 class="text-lg font-semibold text-blue-300 mb-2">Team 1 (Heads)</h4>
                                <select id="t1p1Select" class="w-full p-2 rounded-lg mb-2" onchange="window.updateDuoBattleOdds()">
                                    <option value="">Team 1 (P1)</option>
                                </select>
                                <select id="t1p2Select" class="w-full p-2 rounded-lg" onchange="window.updateDuoBattleOdds()">
                                    <option value="">Team 1 (P2)</option>
                                </select>
                            </div>
                            <!-- Team 2 (Red) -->
                            <div class="p-3 bg-red-900/30 rounded-lg">
                                <h4 class="text-lg font-semibold text-red-300 mb-2">Team 2 (Tails)</h4>
                                <select id="t2p1Select" class="w-full p-2 rounded-lg mb-2" onchange="window.updateDuoBattleOdds()">
                                    <option value="">Team 2 (P1)</option>
                                </select>
                                <select id="t2p2Select" class="w-full p-2 rounded-lg" onchange="window.updateDuoBattleOdds()">
                                    <option value="">Team 2 (P2)</option>
                                </select>
                            </div>
                        </div>
                        
                        <p id="duoOddsDisplay" class="text-center text-lg font-bold text-slate-300 my-4">Odds: Team 1 (50%) vs Team 2 (50%)</p>

                        <div class="flex items-center justify-center space-x-6">
                            <div class="text-center">
                                <span id="scoreT1" class="text-4xl cinzel text-blue-400">0</span>
                                <p class="text-xs text-slate-400">Team 1 Score</p>
                            </div>
                            <button onclick="window.duoBattleFlip()" class="btn-primary py-3 px-6 rounded-full text-lg">
                                <i class="fa-solid fa-dice-three mr-2"></i> Launch War
                            </button>
                            <div class="text-center">
                                <span id="scoreT2" class="text-4xl cinzel text-red-400">0</span>
                                <p class="text-xs text-slate-400">Team 2 Score</p>
                            </div>
                        </div>
                        
                        <div id="duoCoin" class="relative">
                            <div class="coin-face front"><i class="fa-solid fa-shield-halved"></i></div>
                            <div class="coin-face back"><i class="fa-solid fa-bolt"></i></div>
                        </div>
                        <div id="duoFlipResultDisplay" class="text-center h-12 flex flex-col justify-center">
                            <!-- Flip result goes here -->
                        </div>
                        <button onclick="window.resetDuoBattle()" class="w-full text-xs text-slate-500 hover:text-red-500 mt-2">Reset Score</button>
                    </div>

                </div>

            </div>
        </div>
        
        <!-- Footer Spacer -->
        <div class="h-10"></div>
    </div>
</body>
</html>