<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Realm Entry</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Deep space background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .card {
            background-color: #2e2e4f; /* Slightly lighter card background */
            color: #e4e4f0;
            border: 2px solid #5a5a7f;
        }
        .btn-primary {
            background-color: #ff5757; /* Accent color */
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #ff3c3c;
            box-shadow: 0 4px 15px rgba(255, 87, 87, 0.4);
        }
        .realm-button-active {
            background-color: #5a5a7f !important;
            color: #fff !important;
            border-color: #ff5757;
            box-shadow: 0 0 10px rgba(255, 87, 87, 0.6);
        }
        input[type="text"] {
            background-color: #1a1a2e;
            color: #e4e4f0;
            border: 1px solid #5a5a7f;
        }
        /* Custom scrollbar for user list */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #ff5757;
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #2e2e4f;
        }
    </style>
</head>
<body>
    <div id="app-container" class="w-full max-w-xl">
        <!-- Loading screen while Firebase initializes -->
        <div id="loading-screen" class="flex flex-col items-center justify-center h-48 text-center text-gray-400">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-pink-500"></div>
            <p class="mt-4 text-lg font-medium">Initializing Connection...</p>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables and Configuration ---
        let app;
        let db;
        let auth;
        let userId = null;
        let userUnsubscribe = null; // Listener for the current realm

        // Mandatory Global Variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Application State Management
        const AppState = {
            currentScreen: 'loading', // 'loading', 'entry', or 'lobby'
            username: localStorage.getItem('realmUsername') || '',
            selectedRealm: localStorage.getItem('selectedRealm') || 'Alpha',
            lobbyUsers: [],
            isAuthReady: false,
            realmNames: ['Alpha', 'Beta', 'Gamma', 'Delta'],
        };

        // --- UI Rendering Functions ---

        /** Renders the current view based on AppState */
        function render() {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            // Clear previous content but preserve loading state if needed
            if (AppState.currentScreen !== 'loading') {
                appContainer.innerHTML = '';
            }

            if (!AppState.isAuthReady) {
                // If not ready, keep the initial loading screen visible
                document.getElementById('loading-screen').classList.remove('hidden');
                return;
            } else {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) loadingScreen.classList.add('hidden');
            }

            // Render different screens
            if (AppState.currentScreen === 'entry') {
                appContainer.innerHTML = createEntryScreen();
                setupEntryListeners();
            } else if (AppState.currentScreen === 'lobby') {
                appContainer.innerHTML = createLobbyScreen();
                setupLobbyListeners();
            }
        }

        /** Templates the Entry Screen (Username/Realm Selection) */
        function createEntryScreen() {
            return `
                <div class="card p-6 sm:p-10 w-full max-w-md rounded-xl shadow-2xl transition-all duration-300 transform scale-100 hover:scale-[1.01]">
                    <h1 class="text-3xl font-extrabold text-white mb-2 text-center">Enter the Nexus</h1>
                    <p class="text-xs text-gray-400 mb-6 text-center">Your ID: <span class="font-mono text-pink-400">${userId.substring(0, 8)}...</span></p>

                    <!-- Username Input -->
                    <div class="mb-6">
                        <label for="username-input" class="block text-sm font-medium text-gray-300 mb-2">Explorer Name (Min 3 Chars)</label>
                        <input type="text" id="username-input" placeholder="Your Explorer Name" value="${AppState.username}"
                               class="w-full px-4 py-3 rounded-lg focus:ring-pink-500 focus:border-pink-500 shadow-lg"
                               maxlength="20" required>
                    </div>

                    <!-- Realm Selection -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-300 mb-3">Choose a Starting Realm</h2>
                        <div class="grid grid-cols-2 gap-3">
                            ${AppState.realmNames.map(realm => `
                                <button data-realm="${realm}"
                                        class="realm-button w-full px-4 py-3 rounded-lg text-sm font-bold transition-all duration-200 shadow-md
                                        ${AppState.selectedRealm === realm
                                            ? 'realm-button-active'
                                            : 'bg-indigo-700 text-gray-200 hover:bg-indigo-600'
                                        }">
                                    ${realm} Realm
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Enter Button -->
                    <button id="enter-realm-button"
                            class="w-full py-3 px-4 btn-primary text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50 disabled:bg-gray-500"
                            disabled>
                        Join ${AppState.selectedRealm}
                    </button>
                    <p id="error-message" class="text-pink-500 text-sm mt-3 text-center hidden font-semibold">Username must be between 3 and 20 characters.</p>
                </div>
            `;
        }

        /** Templates the Lobby Screen (Online Users) */
        function createLobbyScreen() {
            return `
                <div class="card p-6 sm:p-10 w-full max-w-md rounded-xl shadow-2xl transition-all duration-300">
                    <h1 class="text-3xl font-extrabold text-pink-400 mb-2 text-center">Lobby: ${AppState.selectedRealm} Realm</h1>
                    <p class="text-sm text-gray-400 mb-6 text-center">
                        Welcome, <span class="font-bold text-white">${AppState.username}</span>. Awaiting your next move.
                    </p>

                    <!-- Current Users List -->
                    <div class="bg-[#1a1a2e] p-4 rounded-lg shadow-inner mb-6 max-h-64 overflow-y-auto">
                        <h2 class="text-xl font-semibold text-gray-300 mb-3 border-b border-[#5a5a7f] pb-2">Online Explorers (${AppState.lobbyUsers.length})</h2>
                        <ul id="users-list" class="space-y-2">
                            ${AppState.lobbyUsers.map(user => `
                                <li class="flex items-center justify-between p-3 bg-[#2e2e4f] rounded-md shadow-md transition-all duration-150 ${user.id === userId ? 'border border-pink-500' : 'border border-[#2e2e4f]'}">
                                    <span class="font-bold ${user.id === userId ? 'text-pink-400' : 'text-white'}">${user.username}</span>
                                    <span class="text-xs text-gray-500">${user.id === userId ? '(You)' : ''}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <!-- Exit Button -->
                    <button id="exit-realm-button"
                            class="w-full py-3 px-4 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition duration-300">
                        Exit Realm
                    </button>
                </div>
            `;
        }


        // --- State/Data Management ---

        /** Updates the username and persists it */
        function setUsername(name) {
            AppState.username = name.trim();
            localStorage.setItem('realmUsername', AppState.username);
        }

        /** Updates the selected realm and persists it */
        function selectRealm(realmId) {
            AppState.selectedRealm = realmId;
            localStorage.setItem('selectedRealm', AppState.selectedRealm);
            render(); // Re-render to update the active button and join text
        }

        /** Sets up listeners for the Entry Screen */
        function setupEntryListeners() {
            const input = document.getElementById('username-input');
            const button = document.getElementById('enter-realm-button');
            const realmButtons = document.querySelectorAll('.realm-button');
            const errorMessage = document.getElementById('error-message');

            // Initial button state check
            const isValid = AppState.username.length >= 3 && AppState.username.length <= 20;
            button.disabled = !isValid;
            button.textContent = `Join ${AppState.selectedRealm} Realm`;

            // Input listener for live validation
            input.addEventListener('input', (e) => {
                setUsername(e.target.value);
                const currentValid = AppState.username.length >= 3 && AppState.username.length <= 20;

                if (currentValid) {
                    button.disabled = false;
                    errorMessage.classList.add('hidden');
                } else {
                    button.disabled = true;
                    if (AppState.username.length > 0) {
                        errorMessage.classList.remove('hidden');
                    }
                }
            });

            // Realm selection listeners
            realmButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    selectRealm(e.currentTarget.dataset.realm);
                });
            });

            // Enter button listener
            button.addEventListener('click', async () => {
                if (!button.disabled) {
                    button.disabled = true;
                    button.textContent = 'Connecting...';
                    await joinRealm(AppState.selectedRealm);
                }
            });
        }

        /** Sets up listeners for the Lobby Screen and real-time data */
        function setupLobbyListeners() {
            // Start real-time listener for the realm's user list
            listenToRealm(AppState.selectedRealm);

            // Exit button listener
            document.getElementById('exit-realm-button').addEventListener('click', async () => {
                document.getElementById('exit-realm-button').disabled = true;
                document.getElementById('exit-realm-button').textContent = 'Exiting...';
                await exitRealm(AppState.selectedRealm);
            });
        }

        /** Handles adding the user to the Firestore realm document */
        async function joinRealm(realmId) {
            if (!userId || !AppState.username) return;

            const realmRef = doc(db, `/artifacts/${appId}/public/data/realms`, realmId);

            try {
                await runTransaction(db, async (transaction) => {
                    const realmDoc = await transaction.get(realmRef);
                    let users = realmDoc.exists ? realmDoc.data().users || {} : {};

                    // Add or update current user details (status: 'online')
                    users[userId] = {
                        username: AppState.username,
                        joinedAt: Date.now(),
                        status: 'online',
                        id: userId
                    };

                    transaction.set(realmRef, { users: users }, { merge: true });
                });

                // Success: Transition to lobby screen
                AppState.currentScreen = 'lobby';
                render();

            } catch (error) {
                console.error("Failed to join realm:", error);
                const button = document.getElementById('enter-realm-button');
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) {
                    errorMessage.textContent = 'Error joining realm. Check console.';
                    errorMessage.classList.remove('hidden');
                }
                if (button) {
                    button.disabled = false;
                    button.textContent = `Join ${AppState.selectedRealm} Realm`;
                }
            }
        }

        /** Sets up the onSnapshot listener for the selected realm */
        function listenToRealm(realmId) {
            if (userUnsubscribe) {
                userUnsubscribe(); // Detach existing listener
            }

            const realmRef = doc(db, `/artifacts/${appId}/public/data/realms`, realmId);

            userUnsubscribe = onSnapshot(realmRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const usersMap = docSnapshot.data().users || {};

                    // Filter for online users and convert to array
                    const newUsersArray = Object.values(usersMap)
                        .filter(user => user && user.status === 'online' && user.username)
                        .sort((a, b) => b.joinedAt - a.joinedAt);

                    AppState.lobbyUsers = newUsersArray;

                    // Update the UI if we are in the lobby state
                    if (AppState.currentScreen === 'lobby') {
                        updateLobbyUserList();
                    }
                } else {
                    // Initialize the realm document if it doesn't exist
                    setDoc(realmRef, { users: {} }, { merge: true });
                    AppState.lobbyUsers = [];
                    if (AppState.currentScreen === 'lobby') {
                        updateLobbyUserList();
                    }
                }
            }, (error) => {
                console.error("Error listening to realm:", error);
                // Handle error
            });
        }

        /** Updates the user list UI element only */
        function updateLobbyUserList() {
            const usersListElement = document.getElementById('users-list');
            if (usersListElement) {
                usersListElement.innerHTML = AppState.lobbyUsers.map(user => `
                    <li class="flex items-center justify-between p-3 bg-[#1a1a2e] rounded-md shadow-md transition-all duration-150 ${user.id === userId ? 'border border-pink-500' : 'border border-transparent'}">
                        <span class="font-bold ${user.id === userId ? 'text-pink-400' : 'text-white'}">${user.username}</span>
                        <span class="text-xs text-gray-500">${user.id === userId ? '(You)' : ''}</span>
                    </li>
                `).join('');

                const header = usersListElement.closest('.bg-[#1a1a2e]').previousElementSibling;
                if (header) {
                    header.innerHTML = `<h1 class="text-3xl font-extrabold text-pink-400 mb-2 text-center">Lobby: ${AppState.selectedRealm} Realm</h1><p class="text-sm text-gray-400 mb-6 text-center">Welcome, <span class="font-bold text-white">${AppState.username}</span>. Awaiting your next move.</p>`;
                }
                const countHeader = usersListElement.closest('.bg-[#1a1a2e]').querySelector('h2');
                 if (countHeader) {
                    countHeader.innerHTML = `Online Explorers (${AppState.lobbyUsers.length})`;
                }
            }
        }

        /** Handles removing the user from the Firestore realm document */
        async function exitRealm(realmId) {
            if (!userId) return;

            if (userUnsubscribe) {
                userUnsubscribe(); // Detach the listener
                userUnsubscribe = null;
            }

            const realmRef = doc(db, `/artifacts/${appId}/public/data/realms`, realmId);

            try {
                await runTransaction(db, async (transaction) => {
                    const realmDoc = await transaction.get(realmRef);
                    if (realmDoc.exists) {
                        let users = realmDoc.data().users || {};

                        if (users[userId]) {
                            // Set status to 'offline' instead of deleting
                            users[userId].status = 'offline';
                            users[userId].leftAt = Date.now();
                        }

                        transaction.set(realmRef, { users: users }, { merge: true });
                    }
                });

            } catch (error) {
                console.error("Failed to exit realm gracefully:", error);
            } finally {
                // Always transition client-side for immediate feedback
                AppState.lobbyUsers = [];
                AppState.currentScreen = 'entry';
                render();
            }
        }


        // --- Initialization ---

        async function initializeFirebase() {
            try {
                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Check and set initial authentication state
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            // Sign in if not authenticated
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser.uid;
                        }
                        unsubscribe();
                        resolve();
                    });
                });

                // Set initial application state after authentication
                AppState.isAuthReady = true;
                AppState.currentScreen = 'entry'; // Start at the entry screen

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('app-container').innerHTML = `
                    <div class="p-8 text-center text-red-400 card rounded-xl">
                        <h2 class="text-xl font-bold">Connection Error</h2>
                        <p class="mt-2">Could not connect to Firebase. Check console for details.</p>
                        <p class="mt-1 font-mono text-sm text-gray-400">${error.message}</p>
                    </div>
                `;
            }

            render(); // Initial render to show the entry screen
        }

        window.onload = initializeFirebase;
    </script>
</body>
</html>