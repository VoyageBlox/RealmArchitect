<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realm Architect: Multiplayer Edition</title>
    <!-- Tailwind CDN for styling --><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght=300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark Slate Gray */
            color: #d1d5db; /* Light Gray */
            overflow-x: hidden;
            position: relative;
        }
        .cinzel {
            font-family: 'Cinzel', serif;
        }
        .card {
            background-color: #374151; /* Medium Slate Gray */
            border: 1px solid #4b5563; /* Border */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #f59e0b; /* Amber */
            color: #1f2937;
            font-weight: bold;
            transition: all 0.15s;
        }
        .btn-primary:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .coin-face {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #coin, #duoCoin {
            width: 80px;
            height: 80px;
            margin: 20px auto;
            transform-style: preserve-3d;
            perspective: 1000px;
            transition: transform 1.5s cubic-bezier(0.4, 2.5, 0.55, 0.5);
        }
        #coin .front { background-color: #10b981; transform: rotateY(0deg); }
        #coin .back { background-color: #ef4444; transform: rotateY(180deg); }
        #duoCoin .front { background-color: #3b82f6; transform: rotateY(0deg); } /* Blue */
        #duoCoin .back { background-color: #ef4444; transform: rotateY(180deg); } /* Red */
        
        input[type="text"], select, textarea {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #f3f4f6;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 1px #f59e0b;
        }

        /* --- WONKY BACKGROUND STYLES --- */
        .cube-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background-color: #0d1117;
        }
        
        .shape {
            position: absolute;
            transform-style: preserve-3d;
            opacity: 0.07; /* Very subtle opacity */
        }
        
        /* CUBE Styles */
        .cube {
            width: 50px;
            height: 50px;
            animation: floatAndRotate 20s infinite ease-in-out;
        }
        .cube-face {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .cube-face.front  { transform: rotateY(0deg) translateZ(25px); }
        .cube-face.back   { transform: rotateX(180deg) translateZ(25px); }
        .cube-face.right  { transform: rotateY(90deg) translateZ(25px); }
        .cube-face.left   { transform: rotateY(-90deg) translateZ(25px); }
        .cube-face.top    { transform: rotateX(90deg) translateZ(25px); }
        .cube-face.bottom { transform: rotateX(-90deg) translateZ(25px); }

        /* TRIANGLE Styles */
        .triangle {
            width: 0;
            height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-bottom: 86.6px solid rgba(168, 85, 247, 0.05); /* Fuchsia/Purple */
            animation: wonkyTriangle 15s infinite linear;
            filter: blur(1px);
        }
        
        /* CIRCLE/SWIRL Styles */
        .swirl {
            width: 70px;
            height: 70px;
            background: transparent;
            border: 5px solid;
            border-color: rgba(245, 158, 11, 0.05) transparent rgba(245, 158, 11, 0.05) transparent; /* Amber */
            border-radius: 50%;
            animation: swirlRotate 25s infinite linear;
        }

        /* KEYFRAMES */
        @keyframes floatAndRotate {
            0% { transform: translate(0, 0) rotateX(0deg) rotateY(0deg); }
            25% { transform: translate(10vw, 5vw) rotateX(90deg) rotateY(45deg); }
            50% { transform: translate(0, 10vw) rotateX(180deg) rotateY(90deg); }
            75% { transform: translate(-10vw, 5vw) rotateX(270deg) rotateY(135deg); }
            100% { transform: translate(0, 0) rotateX(360deg) rotateY(180deg); }
        }

        @keyframes wonkyTriangle {
            0% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(20vw, 15vh) rotate(120deg) scale(0.8); }
            66% { transform: translate(5vw, 30vh) rotate(240deg) scale(1.1); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        
        @keyframes swirlRotate {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(0.9); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        /* Ensure content is above the background */
        .content-container {
            position: relative;
            z-index: 1;
        }

    </style>
    
    <!-- ⚠️ YOUR FIREBASE CONFIGURATION ⚠️ --><script>
        // CONFIGURATION
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyCoRExE1mKJqKb6b5Kv1Suxun4DuMkMnG0",
            authDomain: "real-96b07.firebaseapp.com",
            projectId: "real-96b07",
            storageBucket: "real-96b07.firebasestorage.app",
            messagingSenderId: "699368878306",
            appId: "1:699368878306:web:936026a24ec82a0d59eebb",
            measurementId: "G-H86F01XPM3"
        });
        window.__app_id = "real-96b07"; 
        
        // FLAG TO TRACK SUCCESS
        window.firebaseInitSuccess = false;
    </script>
    
    <!-- Firebase Imports and Main Application Logic --><script type="module">
        // 1. Static Imports: Using CDN links for browser compatibility
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- UTILITY FUNCTIONS ---
        function showNotification(message, className) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-[99] p-4 rounded-lg shadow-xl text-white font-bold transition-all duration-300 ${className}`;
            notification.innerHTML = `<i class="fa-solid fa-bell mr-2"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.classList.remove('top-4');
                notification.classList.add('top-0');
                setTimeout(() => notification.remove(), 500);
            }, 5000); 
        }

        window.renderPlayers = () => {
            const list = document.getElementById('playerList');
            const currentPlayers = window.players || [];
            
            if (currentPlayers.length === 0) {
                list.innerHTML = '<li class="text-slate-500 text-center text-sm p-4">Waiting for players to join...</li>';
                return;
            }

            const sortedPlayers = [...currentPlayers].sort((a, b) => b.techLevel - a.techLevel);
            
            list.innerHTML = sortedPlayers.map(p => `
                <li class="p-3 bg-slate-700/50 rounded-lg flex justify-between items-center border border-slate-600 shadow-md">
                    <div class="flex items-center space-x-3">
                        <i class="fa-solid fa-user-circle text-lg ${p.id === localPlayerId ? 'text-green-400' : 'text-slate-400'}"></i>
                        <span class="font-bold ${p.id === localPlayerId ? 'text-white' : 'text-slate-200'}">${p.name} ${p.id === localPlayerId ? '(You)' : ''}</span>
                    </div>
                    <div class="text-right text-sm">
                        <span class="text-yellow-400 font-mono">⚡${p.energy}</span>
                        <span class="text-indigo-400 ml-3">Tech: ${p.techLevel}</span>
                        ${p.inventory && p.inventory.length > 0 ? `<span class="ml-3 text-red-300">⚔️ ${p.inventory.length} items</span>` : ''}
                    </div>
                </li>
            `).join('');
            
            const currentPlayer = currentPlayers.find(p => p.id === localPlayerId);
            if(currentPlayer) {
                document.getElementById('myEnergyDisplay').innerText = currentPlayer.energy;
                document.getElementById('myTechLevelDisplay').innerText = currentPlayer.techLevel;
            }

            // Also update the World Data Preview if available
            const worldPreview = document.getElementById('worldDataPreview');
            if (currentPlayer && currentPlayer.worldData && currentPlayer.worldData.countryName) {
                const data = currentPlayer.worldData;
                worldPreview.innerHTML = `
                    <p class="text-sm font-bold text-slate-100 mb-1">${data.countryName || 'Untitled Country'}</p>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                        <p class="text-slate-400"><i class="fa-solid fa-mountain-sun mr-1"></i> Terrain: ${data.terrain}</p>
                        <p class="text-slate-400"><i class="fa-solid fa-cloud-sun-rain mr-1"></i> Climate: ${data.climate}</p>
                        <p class="text-slate-400"><i class="fa-solid fa-gem mr-1"></i> Resources: ${data.resources}</p>
                        <p class="text-slate-400"><i class="fa-solid fa-arrow-right-arrow-left mr-1"></i> Export: ${data.export}</p>
                    </div>
                    <p class="text-xs text-slate-500 italic mt-2">${data.unique ? data.unique.substring(0, 50) + '...' : 'No unique trait defined.'}</p>
                `;
            } else {
                worldPreview.innerHTML = '<p class="text-xs text-slate-500 italic">No world data saved yet. Fill out the form below to create your country!</p>';
            }
        };
        
        // --- NEW FUNCTION TO LOAD LIVE DATA INTO THE FORM ---
        window.loadWorldData = () => {
            const currentPlayer = window.players.find(p => p.id === localPlayerId);
            const formElements = document.getElementById('worldForm').elements;
            
            if (!currentPlayer || !currentPlayer.worldData) {
                // Clear or initialize form if no data exists (implicitly creates a "new" country)
                document.getElementById('worldForm').reset();
                formElements.resources.value = 'None'; 
                // Set initial values if you want defaults instead of empty
            } else {
                const data = currentPlayer.worldData;
                
                // Populate form fields from the current player's worldData
                // This connects the form to the "live stats" (the player object in the array)
                formElements.terrain.value = data.terrain || 'Plains';
                formElements.resources.value = data.resources || 'None';
                formElements.climate.value = data.climate || 'Temperate';
                formElements.countryName.value = data.countryName || '';
                formElements.capitalCity.value = data.capitalCity || '';
                formElements.language.value = data.language || '';
                formElements.export.value = data.export || '';
                formElements.culture.value = data.culture || '';
                formElements.history.value = data.history || '';
                formElements.unique.value = data.unique || '';
            }

            // Ensure the crafting resource dropdown reflects the player's resource choice
            window.checkCraftingOptions();
        };

        window.updateSelects = () => {
            const currentPlayers = window.players || [];
            const playerOptions = currentPlayers.map(p => `<option value="${p.id}">${p.name} (T${p.techLevel})</option>`).join('');
            
            const updateSelect = (id, defaultText) => {
                const el = document.getElementById(id);
                const currentVal = el.value;
                el.innerHTML = `<option value="">${defaultText}</option>` + playerOptions;
                if (currentVal && currentPlayers.find(p => p.id === currentVal)) {
                    el.value = currentVal;
                }
            };

            updateSelect('p1Select', 'P1 - Select Player');
            updateSelect('p2Select', 'P2 - Select Player');
            updateSelect('researcherSelect', 'Select Researcher');
            updateSelect('crafterSelect', 'Select Crafter');
            updateSelect('t1p1Select', 'Team 1 (P1)');
            updateSelect('t1p2Select', 'Team 1 (P2)');
            updateSelect('t2p1Select', 'Team 2 (P1)');
            updateSelect('t2p2Select', 'Team 2 (P2)');

            window.updateBattleOdds();
            window.updateDuoBattleOdds();
            window.checkCraftingOptions();
        };

        window.findPlayerById = (id) => (window.players || []).find(p => p.id === id);

        // Logic for World Data Save (Realm Save Data button fix)
        window.saveWorldToPlayer = async () => {
            if (!localPlayerId) return showNotification("You are not logged in!", 'bg-red-600');
            
            const currentPlayer = window.players.find(p => p.id === localPlayerId);
            if (!currentPlayer) {
                // This scenario should be rare if localPlayerId is always in window.players,
                // but good to have a fallback. In the setupRealtimeListener, we ensure 
                // the current player is added if not present.
                console.error("Local player object not found in window.players array.", localPlayerId, window.players);
                // FIX: Added the correct error message requested by the user's previous context
                return showNotification("Player object not found in data. Please refresh.", 'bg-red-600');
            }

            const formElements = document.getElementById('worldForm').elements;
            const worldData = {
                terrain: formElements.terrain.value,
                resources: formElements.resources.value,
                climate: formElements.climate.value,
                countryName: formElements.countryName.value,
                capitalCity: formElements.capitalCity.value,
                language: formElements.language.value,
                export: formElements.export.value,
                culture: formElements.culture.value,
                history: formElements.history.value,
                unique: formElements.unique.value,
            };

            // 1. Update ONLY the current player's entry in the global array
            const updatedPlayers = window.players.map(p => {
                if (p.id === localPlayerId) {
                    // This is the core logic that prevents changing other players' data
                    return { 
                        ...p, 
                        worldData: worldData, // Saved from the form
                        lastUpdate: Date.now()
                    };
                }
                // Return all other players' data unchanged
                return p;
            });

            // 2. Save the whole updated array back to Firestore
            const success = await window.saveToDb(updatedPlayers);
            if (success) {
                showNotification("World Data Saved Successfully!", 'bg-green-600');
            }
        };

        window.conductResearch = async () => {
            const playerId = document.getElementById('researcherSelect').value;
            if (!playerId) return showNotification("Select a researcher!", 'bg-red-600');
            const player = window.findPlayerById(playerId);
            if (!player) return showNotification("Player not found!", 'bg-red-600');
            // Client-side security check: only the local player can initiate this action for themselves
            if (player.id !== localPlayerId) return showNotification("You can only research for yourself!", 'bg-red-600');
            if (player.energy < 2) return showNotification(`${player.name} needs 2 Energy to research!`, 'bg-red-600');

            const index = window.players.findIndex(p => p.id === playerId);
            const updatedPlayers = [...window.players];
            updatedPlayers[index].energy -= 2;
            updatedPlayers[index].techLevel += 1;
            updatedPlayers[index].lastUpdate = Date.now();

            const success = await window.saveToDb(updatedPlayers);
            if (success) {
                showNotification(`${player.name} researched new tech! Tech Level is now ${updatedPlayers[index].techLevel}.`, 'bg-indigo-600');
            }
        };

        // --- UPDATED CRAFT ITEM LOGIC ---
        window.craftItem = async () => {
            const playerId = document.getElementById('crafterSelect').value;
            const schematic = document.getElementById('schematicInput').value.trim();
            const requiredResource = document.getElementById('resources').value;
            
            if (!playerId) return showNotification("Select a crafter!", 'bg-red-600');
            if (!schematic) return showNotification("Enter a schematic name!", 'bg-red-600');
            if (requiredResource === 'None') return showNotification("Set a primary world resource first!", 'bg-red-600');
            
            const player = window.findPlayerById(playerId);
            if (!player) return showNotification("Player not found!", 'bg-red-600');
            if (player.id !== localPlayerId) return showNotification("You can only craft for yourself!", 'bg-red-600');
            if (player.energy < 5) return showNotification(`${player.name} needs 5 Energy to craft!`, 'bg-red-600');
            if (player.techLevel < 3) return showNotification(`${player.name} needs Tech Level 3 to craft complex items!`, 'bg-red-600');

            const lowerSchematic = schematic.toLowerCase();

            // 1. OP Item Detection (Blacklist)
            const opBlacklist = ['godly', 'infinite', 'nuclear', 'perfect', 'ultimate', 'cheat', 'impenetrable'];
            if (opBlacklist.some(word => lowerSchematic.includes(word))) {
                return showNotification(`Crafting failed: Schematic contains an overpowered keyword ("${schematic}").`, 'bg-red-600');
            }

            // 2. Tech Progression Check (Preventing wooden arrows to guns)
            const techLevel = player.techLevel;
            let blocked = false;
            let reason = '';

            if (techLevel < 2 && (lowerSchematic.includes('steel') || lowerSchematic.includes('iron'))) {
                blocked = true;
                reason = 'Requires Tech Level 2 for basic metallurgy (Iron/Steel).';
            } else if (techLevel < 3 && (lowerSchematic.includes('gun') || lowerSchematic.includes('bomb') || lowerSchematic.includes('engine'))) {
                blocked = true;
                reason = 'Requires Tech Level 3 for basic industrial schematics.';
            } else if (techLevel < 4 && (lowerSchematic.includes('laser') || lowerSchematic.includes('plasma') || lowerSchematic.includes('computer'))) {
                blocked = true;
                reason = 'Requires Tech Level 4 for advanced schematics.';
            }

            if (blocked) {
                return showNotification(`Crafting failed: ${reason} (Current Tech: ${techLevel})`, 'bg-orange-600');
            }
            // End of new crafting logic

            const index = window.players.findIndex(p => p.id === playerId);
            const updatedPlayers = [...window.players];
            updatedPlayers[index].energy -= 5;
            updatedPlayers[index].inventory.push(`${schematic} (${requiredResource})`);
            updatedPlayers[index].lastUpdate = Date.now();

            const success = await window.saveToDb(updatedPlayers);
            if (success) {
                showNotification(`${player.name} crafted ${schematic} using ${requiredResource}!`, 'bg-green-600');
            }
        };

        window.checkCraftingOptions = () => {
            const resource = document.getElementById('worldForm')?.elements?.resources?.value || 'None';
            document.getElementById('craftingStatus').innerText = `Resource: ${resource}`;
        };

        window.updateBattleOdds = () => {
            const p1Id = document.getElementById('p1Select').value;
            const p2Id = document.getElementById('p2Select').value;
            const p1 = window.findPlayerById(p1Id);
            const p2 = window.findPlayerById(p2Id);
            
            let p1Level = p1 ? p1.techLevel : 0;
            let p2Level = p2 ? p2.techLevel : 0;

            if (p1Id === p2Id && p1Id !== "") {
                document.getElementById('oddsDisplay').innerText = "ERROR: Cannot battle yourself!";
                return;
            }

            let diff = p1Level - p2Level;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 5);
            let p1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);
            let p2Odd = 100 - p1Odd;
            document.getElementById('oddsDisplay').innerText = `Odds: P1 (${p1Odd}%) vs P2 (${p2Odd}%)`;
        };

        window.battleFlip = async () => {
            const p1Id = document.getElementById('p1Select').value;
            const p2Id = document.getElementById('p2Select').value;
            const p1 = window.findPlayerById(p1Id);
            const p2 = window.findPlayerById(p2Id);
            if (!p1 || !p2 || p1Id === p2Id) {
                return showNotification("Select two unique players for the battle!", 'bg-red-600');
            }
            // FIX: Removed the check that forced the local player to be involved. 
            // Now any player can initiate any battle for true multiplayer functionality.
            // if (p1Id !== localPlayerId && p2Id !== localPlayerId) {
            //     return showNotification("You must be one of the combatants to initiate a battle!", 'bg-red-600');
            // }

            let diff = p1.techLevel - p2.techLevel;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 5);
            let p1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);

            const coin = document.getElementById('coin');
            coin.style.transition = 'none';
            coin.style.transform = 'rotateY(0deg)';
            await new Promise(resolve => setTimeout(resolve, 50));

            const random = Math.random() * 100;
            const winnerId = (random < p1Odd) ? p1Id : p2Id;
            const flipResult = (winnerId === p1Id) ? 'heads' : 'tails';

            const newBattleState = {
                ...battleState,
                lastBattleId: battleState.lastBattleId + 1,
                result: flipResult,
                winner: winnerId
            };
            if (winnerId === p1Id) {
                newBattleState.p1 += 1;
            } else {
                newBattleState.p2 += 1;
            }
            const success = await window.saveToDb(window.players, newBattleState);
            if (success) {
                // Animation will be triggered by onSnapshot
            }
        };

        window.updateDuoBattleOdds = () => {
            const t1p1 = window.findPlayerById(document.getElementById('t1p1Select').value);
            const t1p2 = window.findPlayerById(document.getElementById('t1p2Select').value);
            const t2p1 = window.findPlayerById(document.getElementById('t2p1Select').value);
            const t2p2 = window.findPlayerById(document.getElementById('t2p2Select').value);
            let t1Level = (t1p1 ? t1p1.techLevel : 0) + (t1p2 ? t1p2.techLevel : 0);
            let t2Level = (t2p1 ? t2p1.techLevel : 0) + (t2p2 ? t2p2.techLevel : 0);
            const allPlayers = [t1p1, t1p2, t2p1, t2p2].filter(p => p);
            const playerIds = allPlayers.map(p => p.id);
            if (new Set(playerIds).size !== playerIds.length) {
                document.getElementById('duoOddsDisplay').innerText = "ERROR: Duplicate players detected!";
                return;
            }
            let diff = t1Level - t2Level;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 3);
            let t1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);
            let t2Odd = 100 - t1Odd;
            document.getElementById('duoOddsDisplay').innerText = `Odds: Team 1 (${t1Odd}%) vs Team 2 (${t2Odd}%)`;
        };

        window.duoBattleFlip = async () => {
            const t1p1 = window.findPlayerById(document.getElementById('t1p1Select').value);
            const t1p2 = window.findPlayerById(document.getElementById('t1p2Select').value);
            const t2p1 = window.findPlayerById(document.getElementById('t2p1Select').value);
            const t2p2 = window.findPlayerById(document.getElementById('t2p2Select').value);

            const t1Ids = [t1p1?.id, t1p2?.id].filter(Boolean);
            const t2Ids = [t2p1?.id, t2p2?.id].filter(Boolean);
            const allIds = [...t1Ids, ...t2Ids];
            // const localPlayerInvolved = allIds.includes(localPlayerId); // Removed for MP functionality

            if (!t1p1 || !t2p1) { 
                return showNotification("Select at least P1 for Team 1 and P1 for Team 2!", 'bg-red-600');
            }
            // if (!localPlayerInvolved) {
            //     return showNotification("You must be part of one of the teams to initiate a battle!", 'bg-red-600');
            // }

            let t1Level = (t1p1 ? t1p1.techLevel : 0) + (t1p2 ? t1p2.techLevel : 0);
            let t2Level = (t2p1 ? t2p1.techLevel : 0) + (t2p2 ? t2p2.techLevel : 0);
            let diff = t1Level - t2Level;
            let baseOdd = 50;
            let adjustment = Math.min(30, Math.abs(diff) * 3);
            let t1Odd = baseOdd + (diff > 0 ? adjustment : -adjustment);
            const coin = document.getElementById('duoCoin');
            coin.style.transition = 'none';
            coin.style.transform = 'rotateY(0deg)';
            await new Promise(resolve => setTimeout(resolve, 50));
            const random = Math.random() * 100;
            const winnerTeam = (random < t1Odd) ? 't1' : 't2';
            const flipResult = (winnerTeam === 't1') ? 'heads' : 'tails';
            const newDuoBattleState = {
                ...duoBattleState,
                lastBattleId: duoBattleState.lastBattleId + 1,
                result: flipResult,
                winner: winnerTeam
            };
            if (winnerTeam === 't1') {
                newDuoBattleState.t1 += 1;
            } else {
                newDuoBattleState.t2 += 1;
            }
            const success = await window.saveToDb(window.players, battleState, newDuoBattleState);
            if (success) {
                // Animation will be triggered by onSnapshot
            }
        };

        window.resetBattle = async () => {
            const newBattleState = { p1: 0, p2: 0, lastBattleId: battleState.lastBattleId, result: null, winner: null };
            const success = await window.saveToDb(window.players, newBattleState, duoBattleState);
            if (success) {
                showNotification("1v1 Score Reset!", 'bg-slate-600');
            }
        };

        window.resetDuoBattle = async () => {
            const newDuoBattleState = { t1: 0, t2: 0, lastBattleId: duoBattleState.lastBattleId, result: null, winner: null };
            const success = await window.saveToDb(window.players, battleState, newDuoBattleState);
              if (success) {
                showNotification("2v2 Score Reset!", 'bg-slate-600');
            }
        };

        window.triggerBattleAnimation = (newState, coinId, resultDisplayId, isDuo = false) => {
            const coin = document.getElementById(coinId);
            const resultDisplay = document.getElementById(resultDisplayId);
            
            // Determine names for display
            let team1Name = isDuo ? 'Team 1 (Blue)' : 'P1';
            let team2Name = isDuo ? 'Team 2 (Red)' : 'P2';
            const p1Select = document.getElementById('p1Select');
            const p2Select = document.getElementById('p2Select');

            if (!isDuo) {
                 const p1 = window.findPlayerById(p1Select.value);
                 const p2 = window.findPlayerById(p2Select.value);
                 if (p1) team1Name = p1.name;
                 if (p2) team2Name = p2.name;
            }
            
            coin.style.transition = 'none';
            coin.style.transform = 'rotateY(0deg)';
            void coin.offsetWidth; 
            coin.style.transition = 'transform 1.5s cubic-bezier(0.4, 2.5, 0.55, 0.5)';
            if (newState.result === 'heads') {
                coin.style.transform = 'rotateY(3600deg)';
            } else {
                coin.style.transform = 'rotateY(3780deg)'; // 3600 + 180
            }
            resultDisplay.innerText = 'Flipping...';

            setTimeout(() => {
                // Determine winner's name correctly based on the current state and selection
                let winnerText;
                if (isDuo) {
                    winnerText = (newState.winner === 't1') ? 'Team 1 (Blue)' : 'Team 2 (Red)';
                } else {
                    winnerText = (newState.winner === p1Select.value) ? team1Name : team2Name;
                }
                
                resultDisplay.innerHTML = `<span class="text-xl font-bold ${newState.result === 'heads' ? 'text-green-400' : 'text-red-400'}">${winnerText} WINS!</span><br><span class="text-sm text-slate-400">(${newState.result})</span>`;
                showNotification(`${winnerText} won the battle!`, newState.result === 'heads' ? 'bg-green-600' : 'bg-red-600');

                // Apply energy loss/gain only for 1v1
                if (!isDuo && p1Select.value && p2Select.value) {
                    const winnerId = newState.winner;
                    const loserId = (winnerId === p1Select.value) ? p2Select.value : p1Select.value;
                    window.applyEnergyChange(winnerId, 1);
                    window.applyEnergyChange(loserId, -1);
                }
                
            }, 1500); // Match animation duration
        };

        window.applyEnergyChange = async (playerId, change) => {
            const index = window.players.findIndex(p => p.id === playerId);
            if (index !== -1) {
                const updatedPlayers = [...window.players];
                updatedPlayers[index].energy += change;
                if (updatedPlayers[index].energy < 0) updatedPlayers[index].energy = 0;
                updatedPlayers[index].lastUpdate = Date.now();
                
                await window.saveToDb(updatedPlayers);
                showNotification(`${updatedPlayers[index].name} ${change > 0 ? 'gained' : 'lost'} ${Math.abs(change)} Energy!`, change > 0 ? 'bg-yellow-600' : 'bg-orange-600');
            }
        };

        // --- FIREBASE INITIALIZATION AND REALTIME LISTENER ---

        let db, auth, localPlayerId;
        window.players = [];
        let battleState = { p1: 0, p2: 0, lastBattleId: 0, result: null, winner: null };
        let duoBattleState = { t1: 0, t2: 0, lastBattleId: 0, result: null, winner: null };

        const firebaseConfig = JSON.parse(window.__firebase_config);
        const appId = window.__app_id;
        const COLLECTION_PATH = `artifacts/${appId}/public/data/realm_state`;
        const DOCUMENT_ID = 'main_state'; // Single document for collaborative state

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            // setLogLevel('debug');
            window.firebaseInitSuccess = true;
            console.log("Firebase initialized.");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            showNotification("Error: Firebase Init Failed. Check Console.", 'bg-red-800');
        }

        async function authenticateAndSetup() {
            if (!window.firebaseInitSuccess) return;

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                localPlayerId = auth.currentUser.uid;
                console.log("Authentication successful. User ID:", localPlayerId);

                // Set up listener for real-time updates
                setupRealtimeListener();
            } catch (error) {
                console.error("Authentication failed:", error);
                showNotification("Error: Authentication Failed. Check Console.", 'bg-red-800');
            }
        }

        async function setupRealtimeListener() {
            const docRef = doc(db, COLLECTION_PATH, DOCUMENT_ID);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 1. Process Players Array
                    const oldPlayers = window.players;
                    window.players = data.players || [];
                    
                    // Ensure the current user is always represented, even if the DB hasn't caught up
                    let currentPlayer = window.players.find(p => p.id === localPlayerId);
                    if (!currentPlayer) {
                        const newPlayer = {
                            id: localPlayerId,
                            name: `Architect-${localPlayerId.substring(0, 4)}`,
                            energy: 10,
                            techLevel: 1,
                            inventory: [],
                            worldData: { 
                                terrain: 'Plains', 
                                climate: 'Temperate', 
                                resources: 'None',
                                countryName: 'My New Realm',
                            },
                            lastUpdate: Date.now()
                        };
                        window.players.push(newPlayer);
                        // Save the new player immediately
                        window.saveToDb(window.players, battleState, duoBattleState);
                    }
                    
                    // 2. Process Battle State
                    const oldBattleState = battleState;
                    battleState = data.battleState || { p1: 0, p2: 0, lastBattleId: 0, result: null, winner: null };
                    
                    // Trigger animation only if the flip count increased AND the flip resulted in a winner
                    if (battleState.lastBattleId > oldBattleState.lastBattleId && battleState.winner) {
                        window.triggerBattleAnimation(battleState, 'coin', 'flipResult', false);
                    }

                    // 3. Process Duo Battle State
                    const oldDuoBattleState = duoBattleState;
                    duoBattleState = data.duoBattleState || { t1: 0, t2: 0, lastBattleId: 0, result: null, winner: null };
                    
                    if (duoBattleState.lastBattleId > oldDuoBattleState.lastBattleId && duoBattleState.winner) {
                        window.triggerBattleAnimation(duoBattleState, 'duoCoin', 'duoFlipResult', true);
                    }
                    
                    // Update UI elements dependent on state
                    window.renderPlayers();
                    window.updateSelects(); // Updates dropdowns
                    
                    document.getElementById('scoreP1').innerText = battleState.p1;
                    document.getElementById('scoreP2').innerText = battleState.p2;
                    document.getElementById('duoScoreT1').innerText = duoBattleState.t1;
                    document.getElementById('duoScoreT2').innerText = duoBattleState.t2;
                    
                } else {
                    // Initialize the document if it doesn't exist
                    console.log("Document not found. Creating initial state.");
                    window.saveToDb([], battleState, duoBattleState);
                }
            }, (error) => {
                console.error("Error listening to database:", error);
                showNotification("Error: Lost DB Connection. Check Console.", 'bg-red-800');
            });
        }

        window.saveToDb = async (newPlayers, newBattleState = battleState, newDuoBattleState = duoBattleState) => {
            if (!db) return false;
            const docRef = doc(db, COLLECTION_PATH, DOCUMENT_ID);
            
            // Apply exponential backoff for retries
            for (let i = 0; i < 3; i++) {
                try {
                    await setDoc(docRef, { 
                        players: newPlayers, 
                        battleState: newBattleState,
                        duoBattleState: newDuoBattleState,
                        lastModified: Date.now()
                    });
                    return true;
                } catch (error) {
                    if (error.code === 'unavailable' && i < 2) {
                        console.warn(`Firestore unavailable, retrying in ${2 ** i}s...`);
                        await new Promise(res => setTimeout(res, 1000 * (2 ** i)));
                    } else {
                        console.error("Error writing document:", error);
                        showNotification("Error: Failed to save data!", 'bg-red-800');
                        return false;
                    }
                }
            }
            return false;
        };
        
        // Start the application
        authenticateAndSetup();

        // Populate the cube background
        document.addEventListener('DOMContentLoaded', () => {
            const background = document.querySelector('.cube-background');
            const cubeCount = 15; // Fewer cubes
            const triangleCount = 10;
            const swirlCount = 10;

            const createShape = (type, count, className) => {
                for (let i = 0; i < count; i++) {
                    const shape = document.createElement('div');
                    shape.className = `shape ${type} ${className}`;
                    shape.style.left = `${Math.random() * 100}vw`;
                    shape.style.top = `${Math.random() * 100}vh`;
                    shape.style.animationDelay = `-${Math.random() * 20}s`;
                    
                    if (type === 'cube') {
                        shape.style.transform = `translateZ(-${Math.random() * 500}px) rotateX(${Math.random() * 360}deg) rotateY(${Math.random() * 360}deg)`;
                        const faces = ['front', 'back', 'right', 'left', 'top', 'bottom'];
                        faces.forEach(faceName => {
                            const face = document.createElement('div');
                            face.className = `cube-face ${faceName}`;
                            shape.appendChild(face);
                        });
                    }
                    background.appendChild(shape);
                }
            };
            
            createShape('cube', cubeCount);
            createShape('triangle', triangleCount);
            createShape('swirl', swirlCount);

            // Display User ID once auth is ready
            const localUserIdDisplay = document.getElementById('localUserIdDisplay');
            if (localUserIdDisplay) {
                // Wait for auth to complete
                const interval = setInterval(() => {
                    if (localPlayerId) {
                        localUserIdDisplay.innerText = localPlayerId;
                        clearInterval(interval);
                    }
                }, 100);
            }
        });
    </script>

</head>
<body class="min-h-screen">
    
    <!-- Minimalist 3D Cube Background Container -->
    <div class="cube-background"></div>

    <div class="content-container p-4 sm:p-8 max-w-7xl mx-auto">
        
        <!-- Header: Logo and Title -->
        <header class="mb-8 flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center space-x-4">
                <i class="fa-solid fa-gem text-4xl text-fuchsia-400"></i>
                <h1 class="text-4xl cinzel font-bold text-white tracking-wider">
                    Realm Architect <span class="text-fuchsia-400 text-lg block sm:inline-block font-normal">Multiplayer Edition</span>
                </h1>
            </div>
            <div id="playerStatus" class="text-sm font-semibold p-2 rounded-lg bg-gray-700">
                <p>⚡ Energy: <span id="myEnergyDisplay" class="text-yellow-400">--</span> | Tech: <span id="myTechLevelDisplay" class="text-indigo-400">--</span></p>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: World Data & Actions -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- World Data Section -->
                <div class="card p-6 rounded-xl space-y-4">
                    <h2 class="text-2xl cinzel font-semibold text-white border-b border-gray-600 pb-2 flex justify-between items-center">
                        My Realm Data
                        <button onclick="window.loadWorldData()" class="text-sm text-yellow-400 hover:text-yellow-300 font-normal">
                            <i class="fa-solid fa-upload mr-1"></i> Load My Data
                        </button>
                    </h2>
                    
                    <div id="worldDataPreview" class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <!-- Preview loaded here by renderPlayers() -->
                    </div>

                    <form id="worldForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="countryName" class="block text-sm font-medium mb-1">Country Name</label>
                            <input type="text" id="countryName" name="countryName" placeholder="E.g., The Kingdom of Azmar" class="w-full p-2 rounded-lg">
                        </div>
                        
                        <!-- NEW/EXPANDED OPTIONS -->
                        <div>
                            <label for="terrain" class="block text-sm font-medium mb-1">Terrain</label>
                            <select id="terrain" name="terrain" class="w-full p-2 rounded-lg">
                                <option value="Plains">Plains (Balanced)</option>
                                <option value="Mountainous">Mountainous (Defense)</option>
                                <option value="Archipelago">Archipelago (Trade)</option>
                                <option value="Desert">Desert (Rare Resources)</option>
                                <option value="Tundra">Tundra (Endurance)</option>
                                <option value="Swamp">Swamp (Concealment)</option>
                            </select>
                        </div>
                        <div>
                            <label for="climate" class="block text-sm font-medium mb-1">Climate</label>
                            <select id="climate" name="climate" class="w-full p-2 rounded-lg">
                                <option value="Temperate">Temperate (Stable)</option>
                                <option value="Tropical">Tropical (Abundant Growth)</option>
                                <option value="Arid">Arid (Hardiness)</option>
                                <option value="Polar">Polar (Isolation)</option>
                                <option value="Monsoon">Monsoon (Seasonal Cycles)</option>
                                <option value="Mediterranean">Mediterranean (Maritime Influence)</option>
                            </select>
                        </div>
                        <div>
                            <label for="resources" class="block text-sm font-medium mb-1">Primary Resource</label>
                            <select id="resources" name="resources" class="w-full p-2 rounded-lg" onchange="window.checkCraftingOptions()">
                                <option value="None">None Selected</option>
                                <option value="Gold">Gold (Wealth)</option>
                                <option value="Iron">Iron (Industry)</option>
                                <option value="Gems">Gems (Luxury)</option>
                                <option value="Lumber">Lumber (Construction)</option>
                                <option value="Silk">Silk (Culture)</option>
                                <option value="Oil">Oil (Technology)</option>
                                <option value="Spices">Spices (Trade/Food)</option>
                                <option value="Mana Crystals">Mana Crystals (Mystical)</option>
                            </select>
                        </div>
                        <div>
                            <label for="export" class="block text-sm font-medium mb-1">Main Export</label>
                            <input type="text" id="export" name="export" placeholder="E.g., Fine Wine" class="w-full p-2 rounded-lg">
                        </div>
                        <div>
                            <label for="capitalCity" class="block text-sm font-medium mb-1">Capital City</label>
                            <input type="text" id="capitalCity" name="capitalCity" placeholder="E.g., Aethelburg" class="w-full p-2 rounded-lg">
                        </div>
                        <div>
                            <label for="language" class="block text-sm font-medium mb-1">Primary Language</label>
                            <input type="text" id="language" name="language" placeholder="E.g., Common" class="w-full p-2 rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <label for="culture" class="block text-sm font-medium mb-1">Cultural Trait</label>
                            <textarea id="culture" name="culture" rows="2" placeholder="Describe a key cultural value (e.g., highly disciplined military society)" class="w-full p-2 rounded-lg"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="history" class="block text-sm font-medium mb-1">Brief History</label>
                            <textarea id="history" name="history" rows="2" placeholder="A brief note on your nation's past (e.g., founded by warrior-kings)" class="w-full p-2 rounded-lg"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="unique" class="block text-sm font-medium mb-1">Unique Trait</label>
                            <textarea id="unique" name="unique" rows="2" placeholder="The special thing your realm is known for (e.g., Flying ships)" class="w-full p-2 rounded-lg"></textarea>
                        </div>
                        
                        <div class="md:col-span-2">
                            <button type="button" onclick="window.saveWorldToPlayer()" class="btn-primary w-full p-3 rounded-xl mt-4">
                                <i class="fa-solid fa-floppy-disk mr-2"></i> Realm Save Data
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Action Hub Section -->
                <div class="card p-6 rounded-xl space-y-4">
                    <h2 class="text-2xl cinzel font-semibold text-white border-b border-gray-600 pb-2">Action Hub</h2>
                    
                    <!-- Research Action -->
                    <div class="bg-slate-700/50 p-4 rounded-lg border border-slate-600">
                        <h3 class="font-bold text-lg text-indigo-300 mb-2 flex justify-between items-center">
                            <i class="fa-solid fa-flask mr-2"></i> Research New Tech (-2 Energy)
                        </h3>
                        <div class="flex space-x-2">
                            <select id="researcherSelect" onchange="window.checkCraftingOptions()" class="p-2 rounded-lg flex-grow">
                                <option value="">Select Researcher</option>
                            </select>
                            <button onclick="window.conductResearch()" class="btn-primary p-2 rounded-lg">
                                Conduct Research
                            </button>
                        </div>
                    </div>

                    <!-- Crafting Action -->
                    <div class="bg-slate-700/50 p-4 rounded-lg border border-slate-600">
                        <h3 class="font-bold text-lg text-green-300 mb-2 flex justify-between items-center">
                            <i class="fa-solid fa-hammer mr-2"></i> Craft Item (Tech 3 Req, -5 Energy)
                            <span id="craftingStatus" class="text-sm font-normal text-slate-400">Resource: None</span>
                        </h3>
                        <div class="flex space-x-2">
                            <select id="crafterSelect" onchange="window.checkCraftingOptions()" class="p-2 rounded-lg w-1/3">
                                <option value="">Select Crafter</option>
                            </select>
                            <input type="text" id="schematicInput" placeholder="Schematic Name (e.g., Mythril Shield)" class="p-2 rounded-lg flex-grow">
                            <button onclick="window.craftItem()" class="btn-primary p-2 rounded-lg">
                                Craft
                            </button>
                        </div>
                        <p class="text-xs text-orange-400 mt-2">
                            <i class="fa-solid fa-triangle-exclamation"></i> Crafting progression is now checked: low tech players cannot craft high tech items (e.g., "gun" or "laser"). Overpowered keywords are blocked.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Player List & Battles -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Player List Section -->
                <div class="card p-6 rounded-xl space-y-4">
                    <h2 class="text-2xl cinzel font-semibold text-white border-b border-gray-600 pb-2">
                        Other Players
                    </h2>
                    <p class="text-xs text-slate-400">User ID: <span class="font-mono text-xs text-fuchsia-300 break-all" id="localUserIdDisplay">--</span></p>
                    <ul id="playerList" class="space-y-3">
                        <!-- Player list populated by renderPlayers() -->
                    </ul>
                </div>
                
                <!-- 1v1 Battle Simulator -->
                <div class="card p-6 rounded-xl space-y-4">
                    <h2 class="text-2xl cinzel font-semibold text-white border-b border-gray-600 pb-2">1v1 Battle Simulator</h2>
                    
                    <div class="flex space-x-4">
                        <select id="p1Select" onchange="window.updateBattleOdds()" class="p-2 rounded-lg w-1/2">
                            <option value="">P1 - Select Player</option>
                        </select>
                        <select id="p2Select" onchange="window.updateBattleOdds()" class="p-2 rounded-lg w-1/2">
                            <option value="">P2 - Select Player</option>
                        </select>
                    </div>

                    <p id="oddsDisplay" class="text-center text-sm font-mono text-yellow-300">Odds: P1 (50%) vs P2 (50%)</p>

                    <div id="coin">
                        <div class="coin-face front">P1</div>
                        <div class="coin-face back">P2</div>
                    </div>

                    <div class="flex justify-between items-center">
                        <span id="scoreP1" class="text-2xl font-bold text-green-400">0</span>
                        <div id="flipResult" class="text-center">Click Flip Coin</div>
                        <span id="scoreP2" class="text-2xl font-bold text-red-400">0</span>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="window.battleFlip()" class="btn-primary flex-grow p-3 rounded-lg">
                            <i class="fa-solid fa-coins mr-1"></i> Flip Coin (-1 Energy to Loser, +1 to Winner)
                        </button>
                        <button onclick="window.resetBattle()" class="bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg w-1/4">
                            Reset
                        </button>
                    </div>
                </div>

                <!-- 2v2 Duo Battle Simulator -->
                <div class="card p-6 rounded-xl space-y-4">
                    <h2 class="text-2xl cinzel font-semibold text-white border-b border-gray-600 pb-2">2v2 Duo Battle (Team Tech Total)</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Team 1 (Blue) -->
                        <div class="space-y-2 p-2 bg-blue-900/30 rounded-lg">
                            <h4 class="font-bold text-blue-300">Team 1 (Blue)</h4>
                            <select id="t1p1Select" onchange="window.updateDuoBattleOdds()" class="w-full p-2 rounded-lg">
                                <option value="">Team 1 (P1)</option>
                            </select>
                            <select id="t1p2Select" onchange="window.updateDuoBattleOdds()" class="w-full p-2 rounded-lg">
                                <option value="">Team 1 (P2)</option>
                            </select>
                        </div>
                        <!-- Team 2 (Red) -->
                        <div class="space-y-2 p-2 bg-red-900/30 rounded-lg">
                            <h4 class="font-bold text-red-300">Team 2 (Red)</h4>
                            <select id="t2p1Select" onchange="window.updateDuoBattleOdds()" class="w-full p-2 rounded-lg">
                                <option value="">Team 2 (P1)</option>
                            </select>
                            <select id="t2p2Select" onchange="window.updateDuoBattleOdds()" class="w-full p-2 rounded-lg">
                                <option value="">Team 2 (P2)</option>
                            </select>
                        </div>
                    </div>

                    <p id="duoOddsDisplay" class="text-center text-sm font-mono text-yellow-300">Odds: Team 1 (50%) vs Team 2 (50%)</p>

                    <div id="duoCoin">
                        <div class="coin-face front bg-blue-500">T1</div>
                        <div class="coin-face back bg-red-500">T2</div>
                    </div>

                    <div class="flex justify-between items-center">
                        <span id="duoScoreT1" class="text-2xl font-bold text-blue-400">0</span>
                        <div id="duoFlipResult" class="text-center">Click Flip Coin</div>
                        <span id="duoScoreT2" class="text-2xl font-bold text-red-400">0</span>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="window.duoBattleFlip()" class="btn-primary flex-grow p-3 rounded-lg">
                            <i class="fa-solid fa-dice-three mr-1"></i> Flip Coin
                        </button>
                        <button onclick="window.resetDuoBattle()" class="bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg w-1/4">
                            Reset
                        </button>
                    </div>
                </div>

            </div>
        </main>

    </div>

    <!-- Footer with YouTube link -->
    <footer class="mt-8 p-4 text-center text-xs text-slate-500 border-t border-gray-700 flex justify-center items-center space-x-4">
        <span>Made by Lucas Chase</span>
        <a href="https://www.youtube.com/@VoyagePlays/featured?sub_confirmation=1" target="_blank" rel="noopener noreferrer" class="text-red-500 hover:text-red-400 transition">
            <i class="fa-brands fa-youtube text-xl"></i>
        </a>
    </footer>

</body>
</html>